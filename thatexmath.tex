%{{{ [vim] 
% vim:foldmarker=%{{{,%}}}
% vim:foldmethod=marker
% vim:foldcolumn=4
%}}}
%% thatexmath.tex
%% author: Thanos Tsouanas <thanos@tsouanas.org>

\message{[ThaTeX-math]}

%%{{{ amstex & friends 
\let\knuthcases=\cases
\let\knuthproclaim=\proclaim
\let\knuthS=\S
\let\footnotebeforeamstex=\footnote
\input amstex
\let\footnote=\footnotebeforeamstex
\let\footnotebeforeamstex\relax
% euler fonts
\loadmsam % ams fonts
\loadmsbm % ams fonts
\loadbold % math bold fonts
\loadeufm % fraktur medium-weight 
%\loadeufb % fraktur bold
%\loadeusm % script medium-weight
%\loadeusb % script bold
%\loadeurm % cursive roman medium-weight
%\loadeurb % cursive roman bold
\let\AMSproclaim=\proclaim
\let\proclaim\relax
\input stmary  % (this loads amssym)
\input ofs
\input amsfn
\input mathdots

% ofs
\def\fomenc{AMS}
\setsimplemath

% load the rsfs(o) fonts
\font\tenscr=rsfso10
\font\sevenscr=rsfso7
\font\fivescr=rsfso5
\skewchar\tenscr='177 \skewchar\sevenscr='177 \skewchar\fivescr='177
\newfam\scrfam \textfont\scrfam=\tenscr \scriptfont\scrfam=\sevenscr \scriptscriptfont\scrfam=\fivescr
\def\scr#1{{\fam\scrfam#1}}

% load the ams msbm fonts
% use bbold10, bbold7, bbold5 for an alternative font
% that supports more characters (and digits!)
\font\tenbbb=msbm10
\font\sevenbbb=msbm7
\font\fivebbb=msbm5
\skewchar\tenbbb='177 \skewchar\sevenbbb='177 \skewchar\fivebbb='177
\newfam\bbbfam \textfont\bbbfam=\tenbbb \scriptfont\bbbfam=\sevenbbb \scriptscriptfont\bbbfam=\fivebbb
\def\bbb#1{{\fam\bbbfam#1}}

% load the eufm fonts
\font\teneuf=eufm10
\font\seveneuf=eufm7
\font\fiveeuf=eufm5
\newfam\euffam \textfont\euffam=\teneuf \scriptfont\euffam=\seveneuf \scriptscriptfont\euffam=\fiveeuf
\def\euf#1{{\fam\euffam#1}}

%%}}}

%%{{{ mathfonts 
\def\mathit#1{\hbox{\text{\tenit#1}}}
\def\mathrm#1{\hbox{\text{\tenrm#1}}}
\def\textrmsmallish#1{\hbox{\text{\ninerm#1}}}
\def\mathrmsmallish#1{\hbox{\text{\ninerm#1}}}
\def\mathrmsmall#1{\hbox{\text{\sevenrm#1}}}
\def\mathrmtiny#1{\hbox{\text{\sixrm#1}}}
\def\mathsf#1{\hbox{\text{\tenss#1}}}
\def\mathsfbf#1{\hbox{\text{\sfbf#1}}}
\def\mathsfmbf#1{\hbox{\text{\sfmbf#1}}}
\def\mathsc#1{\hbox{\text{\scshape #1}}}
\def\mathtt#1{\hbox{\text{\tentt#1}}}
\def\mathbf#1{\hbox{\text{\tenbf#1}}}
\def\mathsl#1{\hbox{\text{\tensl#1}}}
\def\txt#1{\text{\tt #1}}
\def\textrm#1{\text{\rm#1}}
\def\namedrel#1{\operatorname{#1}}
\def\namedfun#1{\mathord{\mathit{#1}}}% for functions
\def\namedfpf#1{\mathord{\mathit{#1}}}% for functional programming functions
\def\namedtype#1{\mathord{\mathsf{#1}}}
\def\namedcat#1{\mathord{\mathsfmbf{#1}}}
\def\namedfou#1{\mathord{\mathsfmbf{#1}}}% for foundation/theory acronyms
\def\namedop#1{\operatorname{#1}}
\def\namedoplims#1{\operatornamewithlimits{#1}}
\def\cal{\Cal}
%%}}}

%%{{{ funky symbols 
\def\woohoo{{\ddot\smile}}
\def\boohoo{{\ddot\frown}}
%%}}}

%%{{{ standard sets 
\def\nats{{\bbb N}}
\def\rats{{\bbb Q}}
\def\algs{{\bbb A}}
\def\ints{{\bbb Z}}
\def\reals{{\bbb R}}
\def\complex{{\bbb C}}
\def\bools{{\bbb B}}
\def\polys#1#2{#1\bracket{#2}} % #1: field ; #2: variable
%%}}}

%%{{{ alternative font for other uses (for example implementations) 
\def\Nats{{\mathord{\mathbf N}}}
\def\Rats{{\mathord{\mathbf Q}}}
\def\Ints{{\mathord{\mathbf Z}}}
\def\Reals{{\mathord{\mathbf R}}}
\def\Complex{{\mathord{\mathbf C}}} 
\def\Zero{{\mathsf 0}}%
\def\Succ{{\mathsf S}}%
%%}}}

%%{{{ metadefs 
% \DefPar assumes that its argument is a defined macro of arity 0
% and it creates its parenthesized version, of arity 1
% Example:
% \DefPar succ
% assumes the existence of \succ of arity 0 and it defines \succP of arity 1
\def\DefPar#1 {\csgroup\def{#1P}##1{\csname #1\endcsname\funparen{##1}}}
% \DefApp is similar but defines a space-as-application version
\def\DefApp#1 {\csgroup\def{#1A}##1{\csname #1\endcsname\fa{##1}}}
% \DefTHING #1 #2 \defs a command #1 to be printed as #2 and also takes care
% of the definition of the "parenthesized" version of it if it makes sense
\def\DefREL#1 #2  {\csgroup\def{#1}{{\namedrel{#2}}}\DefPar #1 }
\def\DefFUN#1 #2  {\csgroup\def{#1}{{\namedfun{#2}}}\DefPar #1 \DefApp #1 }
\def\DefFPF#1 #2  {\csgroup\def{#1}{{\namedfpf{#2}}}\DefPar #1 \DefApp #1 }
\def\DefOP#1 #2   {\csgroup\def{#1}{{\namedop{#2}}}\DefPar  #1 \DefApp #1 }
\def\DefOPP#1 #2  {\csgroup\def{#1}##1{{\namedop{#2}\funparen{##1}}}}% always of arity 1, parenthesizing argument
\def\DefTYPE#1 #2 {\csgroup\def{#1}{{\namedtype{#2}}}}
\def\DefCAT#1 #2  {\csgroup\def{#1}{{\namedcat{#2}}}}
\def\DefFOU#1 #2  {\csgroup\def{#1}{{\namedfou{#2}}}}
% Use plain \DefThing if the command name coincides with the printed name
\def\DefRel#1  {\DefREL #1 #1 }
\def\DefFun#1  {\DefFUN #1 #1 }
\def\DefFpf#1  {\DefFPF #1 #1 }
\def\DefOp#1   {\DefOP #1 #1 }
\def\DefOpP#1  {\DefOPP #1 #1 }
\def\DefType#1 {\DefTYPE #1 #1 }
\def\DefCat#1  {\DefCAT #1 #1 }
\def\DefFou#1  {\DefFOU #1 #1 }
% WARNING: use the above macros without % at the end, because it needs
% (and eats) the whitespace.  For example:
% \DefFUN suc succ
% \DefFun fib
% These will create the macros: \suc, \sucP, \sucA, \fib, \fibP, \fibA
% TODO: create \KnuthSave macro
%%}}}

%%{{{ misc symbols 
\def\caret{\hat{}}
\def\heart{\heartsuit}
\def\spade{\spadesuit}
\def\heartop{\mathbin{\heartsuit}}
\def\spadeop{\mathbin{\spadesuit}}
\def\doublemidrel{\mathrel{\mid\mkern-2mu\mid}}
\def\doublemidbin{\mathbin{\mid\mkern-2mu\mid}}
\def\blackleq{\mathrel{\ooalign{\raise .2ex\hbox{$\blacktriangleleft$}\cr$\leq$\cr}}}% TODO: fix size flexibility (text size and mathstyle) (mathpalette?)
\def\subsetbar{\mathrel{\subset\mkern-7.24mu \raise .22ex \hbox{\vrule width .4pt height 1.2ex depth 0ex}}}% TODO: same
\def\bang{\mathord{!}}
\def\postbang#1{\mathord{#1\mkern1mu!}}
\def\postbangp#1{\mathord{\paren{#1}!}}
\def\prebang#1{\mathord{!\mkern1mu#1}}
\def\prebangp#1{\mathord{!\paren{#1}}}
%%}}}

%%{{{ elementary math 
\let\knuthsum=\sum
\let\knuthprod=\prod
\let\Sum=\knuthsum
\let\Product=\knuthprod
\let\Prod=\Product
\let\Coproduct=\coprod
\let\Coprod=\Coproduct
\let\Copr=\Coproduct
\let\sum\relax
\def\prod{\mathbin{\Pi}}
\def\coprod{\amalg}
\def\abs#1{\left|#1\right|}
\def\bigabs#1{\mathopen{\big|}{#1}\mathclose{\big|}}
\def\size#1{\abs{#1}}
\def\nsize#1{\mathord{\#}{#1}}
\def\frac#1#2{{#1\over#2}}
\def\slashfrac#1#2{\leavevmode\kern.1em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.1em/\kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}} % TeXbook x11.6
\let\sfrac=\slashfrac
\def\commaop{\mathbin{,}}
\def\ntimes{\mathbin{\cdot}}
\def\spaceop{\mathbin{\,}}
\def\invisop{{\,}}
\def\juxtap{{}}
\let\sop=\spaceop
\let\stimes=\invisop
\def\nplus{\mathbin{+}}
\def\expop{\mathbin{\caret}}
\def\pow#1{^{#1}}
\def\plus{+}
\def\floor#1{\left\lfloor#1\right\rfloor}
\def\bigfloor#1{\mathopen{\big\lfloor}#1\mathclose{\big\rfloor}}
\def\ceil#1{\left\lceil#1\right\rceil}
\def\cancel#1{\tikz[baseline] \node [strike out,draw,anchor=text,inner sep=0pt,color=black!33,text=black]{$#1$};}
\def\cancelspc#1{\cancel{\,#1\,}}
\def\coloredcancel#1#2{\tikz[baseline] \node [strike out,draw,anchor=text,inner sep=0pt,color=#1,text=black]{$#2$};}
\def\coloredfbcancel#1#2#3{\tikz[baseline] \node [strike out,draw,anchor=text,inner sep=0pt,color=#1,text=#2]{$#3$};}
\def\plusinfty{{+\infty}}
\def\minusinfty{{-\infty}}
\def\pminfty{{\pm\infty}}
\def\mpinfty{{\mp\infty}}
\let\pinfty=\plusinfty
\let\minfty=\minusinfty
\let\posinfty=\pinfty
\let\neginfty=\minfty
\let\nifty=\neginfty
\def\interval#1#2#3{\left#1{#2}\right#3}
\let\ival=\interval
\def\ivaloo(#1,#2){\ival({#1,#2})}
\def\ivaloc(#1,#2]{\ival({#1,#2})}
\def\ivalco[#1,#2){\ival[{#1,#2})}
\def\ivalcc[#1,#2]{\ival[{#1,#2}]}
\def\cbrt#1{{\root3\of{#1}}}
\def\fac#1{{#1}!}
\def\facp#1{\fac{\paren{#1}}}
\def\system#1\endsystem{\math\systemed{#1}\endmath}
\def\systemed#1{\aligned#1\endaligned}
\def\lsystemed#1{\left\{\systemed{#1}\right.}
\def\rsystemed#1{\left.\systemed{#1}\right\}}
\def\bsystemed#1{\left\{\systemed{#1}\right\}}
\def\segment#1{\overline{#1}}
\def\veq{\mathrel{\tikz\node [rotate=90] {=};}}
\let\factorial=\postbang
\let\factorialp=\postbangp
\let\fac=\factorial
\let\facp=\factorialp
\def\numbase #1 #2{{#2}_{\text{\sixss (#1)}}}
%%}}}

%%{{{ matrices 
\def\matrixp#1{\pmatrix#1\endpmatrix}
%%}}}

%%{{{ greek letter symbols 

% save original symbols
\let\knuthepsilon=\epsilon
\let\knuthvarepsilon=\varepsilon
\let\knuththeta=\theta
\let\knuthvartheta=\vartheta
\let\knuthkappa=\kappa
\let\knuthvarkappa=\varkappa
\let\knuthpi=\pi
\let\knuthvarpi=\varpi
\let\knuthrho=\rho
\let\knuthvarrho=\varrho
\let\knuthsigma=\sigma
\let\knuthvarsigma=\varsigma
\let\knuthphi=\phi
\let\knuthvarphi=\varphi

% use the following ones
\let\epsilon=\knuthvarepsilon
\let\lunepsilon=\knuthepsilon
\let\theta=\knuthvartheta
\let\clotheta=\knuththeta
\let\kappa=\knuthkappa
\let\curkappa=\knuthvarkappa
\let\pi=\knuthpi
\let\curpi=\knuthvarpi
\let\rho=\knuthrho
\let\currho=\knuthvarrho
\let\sigma=\knuthsigma
\let\finsigma=\knuthvarsigma
\let\phi=\knuthvarphi
\let\clophi=\knuthphi

% don't use var- cs's
\let\varepsilon=\UNDEFINED
\let\vartheta=\UNDEFINED
\let\varkappa=\UNDEFINED
\let\varpi=\UNDEFINED
\let\varrho=\UNDEFINED
\let\varsigma=\UNDEFINED
\let\varphi=\UNDEFINED

%%}}}

%%{{{ combinatorics 
\def\totperm#1{P_{\text{\sevenss tot}}(#1)}
\def\perm#1#2{P(#1,#2)}
\def\comb#1#2{C(#1,#2)}
\def\binom#1#2{{{#1} \choose {#2}}}
\def\transto{\mathrel{\rightsquigarrow}}
\def\transfrom{\mathrel{\leftsquigarrow}}
\def\bitrans{\leftrightsquigarrow}
\def\permf#1{\matrixp{#1}}
\def\permc#1{{\def\quad{\ \,}\permf{#1}}}
%%}}}

%%{{{ layout/text tools 
\def\proclaim#1{\proclaimstylize{#1}}
\def\centersubr#1#2{\phantom{{}_{#2}}{#1}{{}_{#2}}}
\def\centersubl#1#2{{{}_{#2}}{#1}\phantom{{}_{#2}}}
\def\centersupr#1#2{\phantom{{}^{#2}}{#1}{{}^{#2}}}
\def\centersupl#1#2{{{}^{#2}}{#1}\phantom{{}^{#2}}}
\def\centermidr#1#2{\phantom{\mathord{#2}}{#1}{\mathord{#2}}}
\def\centermidl#1#2{{\mathord{#2}}{#1}\phantom{\mathord{#2}}}
\let\centersub=\centersubr
\let\centersup=\centersupr
\def\halmos{\vrule width .3em height 1.8ex depth .1ex\relax}
\def\lmathwith#1#2{$$\xxalignat2{#1}&{#2}&&\endxxalignat$$}
\def\lmath#1\endlmath{\lmathwith{\qqqquad}{#1}}
\def\leftbrace#1{\left\{#1\right.}
\def\rightbrace#1{\left.#1\right\}}
\let\knuthbrace=\brace
\def\brace#1{\left\{#1\right\}}
\def\leftangle#1{\left<#1\right.}
\def\rightangle#1{\left.#1\right>}
\definecolor{explanationcolor}{cmyk}{0,0,0,.666}
\DefStyle explanation {\color{explanationcolor}}
\def\fact#1{~\ensuremath{^{\text{\explanationstylize{(#1)}}}}}
\def\byfact#1{\text{\explanationstylize{(#1)}}}
\def\reffact#1{\text{\explanationstylize{(#1)}}}
\def\mathby#1{\text{\explanationstylize{(#1)}}}
\def\explanation#1{\text{\explanationstylize{(#1)}}}
\def\by#1{&\qquad&\mathby{#1}}
\def\noby{&\qquad&}
\let\obvious=\noby% needed if no line has any explanation
\def\ltext#1{&\text{#1}&\quad}
\def\rtext#1{&\quad&\text{#1}}
\def\lexplain#1{&\explanation{#1}&\quad}
\def\rexplain#1{&\quad&\explanation{#1}}
\def\qtext#1{\quad\text{#1}\quad}
\def\qqtext#1{\qquad\text{#1}\qquad}
\def\qqqtext#1{\qqquad\text{#1}\qqquad}
\def\qqqqtext#1{\qqqquad\text{#1}\qqqquad}
\def\toverbrace#1#2{\overbrace{#1}^{\text{\eightrm #2}}}% XXX: default \text can't display some non-ascii
\def\moverbrace#1#2{\overbrace{#1}^{{#2}}}
\def\moverbracebig#1#2{\moverbrace {#1} {\dsize #2}}% big (legible) version
\def\tunderbrace#1#2{\underbrace{#1}_{\text{\eightrm #2}}}% XXX: default \text can't display some non-ascii
\def\munderbrace#1#2{\underbrace{#1}_{{#2}}}
\def\munderbracebig#1#2{\munderbrace {#1} {\dsize #2}}% big (legible) version
\let\tobrace=\toverbrace
\let\tubrace=\tunderbrace
\let\mobrace=\moverbrace
\let\mubrace=\munderbrace
\let\mobraceb=\moverbracebig
\let\mubraceb=\munderbracebig
\def\shell#1\endshell{\quote{\tentt #1}\endquote}% TODO: make a real shell macro
% XXX: these contain hacks to help with math ref/labs
\def\math#1\endmath{$$\gather\fixmcount #1\endgather\saveeqnumber$$}
\def\longmath#1\endlongmath{$$\multline\fixmcount #1\endmultline\saveeqnumber$$}
\def\mathcol#1\endmathcol{$$\alignat1\relax\fixmcount #1\endalignat\saveeqnumber$$}
\def\mathcols#1 #2\endmathcols{$$\xalignat#1\relax\fixmcount #2\endxalignat\saveeqnumber$$}
\def\mathxcols#1 #2\endmathxcols{$$\xxalignat#1\relax\fixmcount #2\endxxalignat\saveeqnumber$$}
\def\mathtightcols#1 #2\endmathtightcols{$$\alignat#1\relax\fixmcount #2\endalignat\saveeqnumber$$}
\def\mathnote#1\endmathnote{$$\alignat2\relax\fixmcount #1 \endalignat\saveeqnumber$$}
\def\compute#1\endcompute{$$\alignat2\relax\fixmcount #1\endalignat\saveeqnumber$$}
\def\mathcall#1\endmathcall{%
$$
\def\called##1{&\qqqquad& \textrm{##1}}%
\alignat2\relax\fixmcount
#1
\endalignat\saveeqnumber
$$}
\def\context#1#2 #3\endcontext{% e.g.: \context tm makes text:math default lines
$$
\def\ltype{{#1}}%
\def\rtype{{#2}}%
\ifx\ltype\letterm\def\lstylize##1{##1}\else
\ifx\ltype\lettert\def\lstylize##1{\text{##1}}\fi\fi
\ifx\rtype\letterm\def\rstylize##1{##1}\else
\ifx\rtype\lettert\def\rstylize##1{\text{##1}}\fi\fi
\def\x ##1: ##2; {\lstylize{##1\unskip} &~~\oftype~~\rstylize{##2}}%
\alignat1\relax\fixmcount
#3
\endalignat\saveeqnumber
$$}
\def\proofsteps#1\endproofsteps{$$
\def\steptnb##1{&\text{##1}\\}
\def\stepmnb##1{&{##1}\\}
\def\steptby##1##2{&\text{##1}\by{##2}\\}
\def\stepmby##1##2{&{##1}\by{##2}\\}
\def\thfrtby##1##2{\steptby{\ttherefore##1}{##2}}
\def\thfrmby##1##2{\steptby{\ttherefore$##1$}{##2}}
\def\thfrtnb##1{\steptnb{\ttherefore##1}}
\def\thfrmnb##1{\steptnb{\ttherefore$##1$}}
\alignat2\relax\fixmcount #1\endalignat\saveeqnumber
$$}
\def\ttherefore{$\therefore$~~}
\def\thereforet#1{\text{\ttherefore #1}}
\def\mathmistake#1\endmathmistake{\eop\vskip 1ex\noi\line{\hfill$#1$\hfil\mistake}}
\def\submath#1{\Sb#1\endSb}
\def\supmath#1{\Sp#1\endSp}
\def\mathed#1{\gathered#1\endgathered}
\def\mathcoled#1{\alignedat1\relax #1\endalignedat}
\def\mathcolsed#1 #2{\alignedat#1\relax #2\endalignedat}
\def\mathnoted#1{\alignedat2\relax #1\endalignedat}
\def\computed#1{\alignedat2\relax #1\endalignedat}
\def\sepcol#1{&#1&}
\def\skipcol{\sepcol{}}
\def\quadcol{\sepcol{\quad}}
\def\qquadcol{\sepcol{\qquad}}
\makeatletter
\def\paths#1{%
{%
\def\pathween##1{\faded{\text{\smaller ##1\vphantom{Gg}}}\cr}%
\leftangle{%
\,\vcenter{\normalbaselines\m@th\ialign{$##\hfil$&\quad##\hfil\crcr#1\crcr}%
}}}}
\makeatother
%%}}}

%%{{{ generic TeX symbol machinery 
\def\pmbb#1{{\pmb{\pmb{#1}}}}
\def\smartnot{\mathpalette\NoT}
\def\NoT#1#2{\mathrel{\ooalign{\hfil$#1{#2}$\hfil\cr\hfil$#1/$\hfil}}}
\def\stackrel#1#2{{\buildrel{#1} \over {#2}}}
% aperlis *laps
\def\clap#1{\hbox to 0pt{\hss#1\hss}}
\def\mathllap{\mathpalette\mathllapinternal}
\def\mathrlap{\mathpalette\mathrlapinternal}
\def\mathclap{\mathpalette\mathclapinternal}
\def\mathllapinternal#1#2{\llap{$\mathsurround=0pt#1{#2}$}}
\def\mathrlapinternal#1#2{\rlap{$\mathsurround=0pt#1{#2}$}}
\def\mathclapinternal#1#2{\clap{$\mathsurround=0pt#1{#2}$}}
%%}}}

%%{{{ generic tools 
\def\ensuremath#1{\ifmmode#1\else$#1$\fi}
%\def\eqvdots{\mathmakebox[\widthof{${}={}$}][c]{\vdots}}
\def\eqvdots{\mathrel{\,\,\kern-.05em\mathord{\vdots}\,}}
\def\eqtype{\mathrel{\,\,\kern-.05em:\,}}
\def\treedots{\mathord{\ddots\kern-0.333em\vdots\kern-0.333em\iddots}}
\def\dlabelize#1#2{{#2}_{\textrm{#1}}}
\def\ulabelize#1#2{{#2}^{\textrm{#1}}}
\def\dlabL#1{\dlabelize L {#1}}
\def\dlabR#1{\dlabelize R {#1}}
\def\ulabL#1{\ulabelize L {#1}}
\def\ulabR#1{\ulabelize R {#1}}
\let\labelize=\dlabelize
\let\labL=\dlabL
\let\labR=\dlabR
\def\undertag#1#2{\underline{#1}_{\,{#2}}}
% {top,bottom}{left,right} decorations
\def\tldec#1#2{{}^{#2}\!{#1}}
\def\trdec#1#2{{#1}^{#2}}
\def\bldec#1#2{{}_{#2}{#1}}
\def\brdec#1#2{{#1}_{#2}}
%%}}}

%%{{{ number theory 
\def\divides{\mathrel{\mid}}
\def\divideseqwidth{\;\mathrel{\mid}\;}
\let\knuthcong=\cong
\let\knuthncong=\ncong
\def\cong{\equiv}
\undefine\ncong
\def\ncong{\mathrel{\not\equiv}}
\def\congmod#1{\mathrel{\cong_{#1}}}
\def\modulo#1{\left(\mod{#1}\right)}
\def\ndivides{\mathrel{\nmid}}
\def\gengcd#1{\mathopen{\text{\rm gcd}(}#1\mathclose{)}}
\def\genlcm#1{\mathopen{\text{\rm lcm}(}#1\mathclose{)}}
\def\gcd#1#2{\left(#1,#2\right)}
\def\lcm#1#2{\left[#1,#2\right]}
\def\totsym{\knuthphi}
\def\tot#1{\mathopen{\totsym}\left({#1}\right)\mathclose{}}
\def\intsmod#1{\ints_{#1}}
\def\padics#1{{\mathord{\mathbf Z_{#1}}}}
\DefRel Prime
\DefRel Even
\DefRel Odd
%%}}}

%%{{{ logic metalang 
%\def\iffdf{\mathrel{\overset\triangle\iff}}
\def\iffsymbol{\Longleftrightarrow}
\def\impliessymbol{\Longrightarrow}
\def\impliedbysymbol{\Longleftarrow}
\def\deftag{{\text{\sixss def}}}
\def\abutag{{\text{\sixss abu}}}
\def\sugtag{{\text{\sixss sug}}}
\def\abbrtag{{\text{\sixss abbr}}}
\def\defiff{\mathrel{{\buildrel{\deftag} \over {\iff}}}}
\def\alertdefiff{\mathrel{{\buildrel{\text{\sixss \alert{def}}} \over {\iff}}}}
\def\defiffsymbol{\mathop{\buildrel{\deftag} \over {\Longleftrightarrow}}}
\def\impliesbecause#1{\mathrel{{\buildrel{\text{\explanationstylize{\sixrm #1}}} \over {\implies}}}}
\def\pseudodefiff{\mathrel{{\buildrel{\text{\sixss ``def''}} \over {\iff}}}}
\def\askdots{{\dots\text{?}\dots}}
\def\assiff{\mathrel{\;:\Longleftrightarrow \;}}
\def\iffass{\mathrel{\;\Longleftrightarrow: \;}}
\let\letiff=\assiff
\let\ifflet=\iffass
\def\defeq{\mathrel{{\buildrel{\deftag} \over {=}}}}
\def\alertdefeq{\mathrel{{\buildrel{\text{\sixss \alert{def}}} \over {=}}}}
\def\pseudodefeq{\mathrel{{\buildrel{\text{\sixss ``def''}} \over {=}}}}
\def\pseudoeq{\mathrel{\textrm{``$\mathord{=}$''}}}
% decorate mathrels
\def\spacerel#1{\mathrel{~~{{}#1{}}~~}}
\def\dotsrel#1{\mathrel{{\buildrel{{...}} \over {#1}}}}
\def\longdotsrel#1{\mathrel{{\buildrel{\dots} \over {#1}}}}
\def\heartrel#1{\mathrel{{\buildrel{\heart} \over {#1}}}}
\def\askrel#1{\mathrel{{\buildrel{\text?} \over {#1}}}}
\def\astrel#1{\mathrel{{\buildrel{\text*} \over {#1}}}}
\def\bangrel#1{\mathrel{{\buildrel{\text!} \over {#1}}}}
\def\wowrel#1{\mathrel{{\buildrel{\text{!!}} \over {#1}}}}
\def\wtfrel#1{\mathrel{{\buildrel{\text{?!}} \over {#1}}}}
% TODO: check uses
\def\labelrel#1#2{\mathrel{{\buildrel{\text{#2}} \over {#1}}}}
\def\tagrel#1#2{\mathrel{{\buildrel{\text{\explanationstylize{(#2)}}} \over {#1}}}}
% handy uses:
\def\spaceq{\spacerel=}
\def\heartiff{\heartrel\iff}
\def\askiff{\askrel\iff}
\def\astiff{\astrel\iff}
\def\bangiff{\bangrel\iff}
\def\wowiff{\wowrel\iff}
\def\wtfiff{\wtfrel\iff}
\def\dotsiff{\longdotsrel\iff}
% TODO: check uses
\def\ifflabel#1{\labelrel{\iff}{#1}}
\def\ifftag#1{\reltag{\iff}{#1}}
\def\heartimplies{\heartrel\implies}
\def\askimplies{\askrel\implies}
\def\askimpliedby{\askrel\impliedby}
\def\dotsimplies{\longdotsrel\implies}
\def\dotsimpliedby{\longdotsrel\impliedby}
\def\hearteq{\heartrel=}
\def\askeq{\askrel=}
\def\asteq{\astrel=}
\def\bangeq{\bangrel=}
\def\woweq{\wowrel=}
\def\wtfeq{\wtfrel=}
\def\dotseq{\dotsrel=}
% TODO: check uses
\def\eqlabel#1{\labelrel{=}{#1}}
\def\eqtag#1{\reltag{=}{#1}}
% end of decorated mathrels
\def\eqass{\mathrel{=:}}
\def\asseq{\mathrel{:=}}
\let\leteq=\asseq
\let\eqlet=\eqass
\def\mland{{\mathbin{\;\;\text{\rm \andword}\;\;}}} % metalang and
\def\mlor{{\mathbin{\;\;\text{\rm \orword}\;\;}}}   % metalang or
\def\notimplies{\smartnot\implies}
\def\notimpliedby{\smartnot\impliedby}
\let\nimplies=\notimplies
\let\nimplied=\notimpliedby
\def\tiff{${}\mathrel{\Leftrightarrow}{}$}
\def\timplies{${}\mathrel{\Rightarrow}{}$}
\def\timplied{${}\mathrel{\Leftarrow}{}$}
\def\lrdir{($\Rightarrow$)}
\def\rldir{($\Leftarrow$)}
\def\bidir{($\Leftrightarrow$)}
\def\lrdirset{($\subset$)}
\def\rldirset{($\supset$)}
\def\rlrewrite#1{{#1}$^\leftarrow$}
\def\lrrewrite#1{{#1}$^\rightarrow$}
\def\tripleeq{\mathrel{\equiv}} % symbol
\def\tripleneq{\mathrel{\smartnot{\tripleeq}}} % symbol
\def\tripleasseq{\mathrel{:\equiv}} % symbol
\def\tripleiff{{\Lleftarrow\mkern-3mu\Rrightarrow}} % symbol
\def\tripleshortiff{{\Lleftarrow\mkern-12mu\Rrightarrow}} % symbol
\def\tripleviff{{\raise -.666ex \hbox{\rotated{90}{$\tripleshortiff$}}\mkern-6mu}}
\def\coloredtripleviff#1{{\raise -.666ex \hbox{\rotated{90}{{\color{#1}$\tripleshortiff$}}}\mkern-6mu}}
\let\syneq=\tripleeq        % syntactic
\let\synasseq=\tripleasseq
\let\synneq=\tripleneq
\let\inteq=\tripleeq        % intensional
\let\intneq=\tripleneq
\def\semeq{\mathrel{\eqcirc}}
\def\semneq{\mathrel{\not\eqcirc}}
\def\intiff{\;\mathrel{\tripleiff}\;}
\def\intviff{\tripleviff}
\def\intiffsymbol{\tripleiff}
\def\defintiffsymbol{\mathop{\buildrel{\deftag} \over {\intiffsymbol}}}
\def\abbreq{\mathrel{\;{\buildrel{\abbrtag} \over {\tripleeq}\;}}}
\def\abbriff{\;\mathrel{{\buildrel{\abbrtag} \over {\tripleiff}}\;}}
\def\syndefeq{\mathrel{{\buildrel{\deftag} \over {\syneq}}}}
\def\syndefiff{\;\mathrel{{\buildrel{\deftag} \over {\tripleiff}}\;}}
\def\sugareq{\mathrel{\;{\buildrel{\sugtag} \over {\tripleeq}}\;}}
\def\sugariff{\;\mathrel{{\buildrel{\sugtag} \over {\tripleiff}}\;}}
\def\abusedefeq{\mathrel{{\buildrel{\abutag} \over {\inteq}}}}
\def\abusedefiff{\;\mathrel{{\buildrel{\abutag} \over {\intiff}}\;}}
\let\means=\intiff
\let\vmeans=\intviff
\let\coloredvmeans=\coloredtripleviff
\let\sugiff=\sugariff
\let\sugeq=\sugareq
\let\abbriff=\sugariff
\let\abbrdefiff=\sugdefiff
\def\eqin#1{\mathrel{=_{#1}}}
\let\eqas=\eqin
\def\leadsto{\mathrel{\rightsquigarrow}}
\def\leadstoby#1{\decorateover{#1}{\leadsto}}
%%}}}

%%{{{ grammars 
\def\bnf#1{\left<\mathit{#1}\,\right>}
\def\bnfeq{\mathrel{\;::=\;}}
\def\bnfor{\mathrel{\,\mid\,}}
\def\bnfOR{\mathrel{\,\phantom{::}\,|\,\,\,}}
%%}}}

%%{{{ logic formulae 
\def\univ{U}
\def\limplies{\mathbin{\rightarrow}}
\def\limplied{\mathbin{\leftarrow}}
\def\liff{\mathbin{\leftrightarrow}}
\def\unique{{\exists!}}
\def\quantified#1{\bracket{\thinspace#1\thinspace}}
\def\quantifiedt#1{\quantified{\text{#1}}}
\def\quantifierabbr#1#2#3{\left(\/#1 #2\right)\!\quantified{#3}}
\def\quantifierabbrt#1#2#3{\left(\/#1 #2\right)\!\quantifiedt{#3}}
\def\lforall{\quantifierabbr{\forall}}
\def\lexists{\quantifierabbr{\exists}}
\def\lunique{\quantifierabbr{\unique}}
\def\lforallt{\quantifierabbrt{\forall}}
\def\lexistst{\quantifierabbrt{\exists}}
\def\luniquet{\quantifierabbrt{\unique}}
\def\pexists#1{\paren{\exists#1}}
\def\pforall#1{\paren{\forall#1}}
\def\punique#1{\paren{\unique#1}}
\def\sexists#1{{\exists#1}\,}
\def\sforall#1{{\forall#1}\,}
\def\sunique#1{{\unique#1}\,}
\def\zolang{{\frak L_0}}
\def\folang{{\frak L_1}}
\def\zolvars{{\mathrm{Pvar}}}
\def\folvars{{\mathrm{Var}}}
\def\folcons{{\mathrm{Con}}}
\def\folfuns{{\mathrm{Fun}}}
\def\folpreds{{\mathrm{Pred}}}
\def\folterms{{\cal T}}
\def\folarity{{\mathbf{a}}}
\def\lsym#1{\mathsf{#1}}
%%}}}

%%{{{ metalang formula-like notations 
\def\mexists{\exists}
\def\mforall{\forall}
\def\munique{\unique}
\def\mlimplies{\implies}
\def\mliff{\iff}
\def\mlimplied{\impliedby}
\def\mlquantified#1{\bracket{\thinspace#1\thinspace}}
\def\mlquantifierabbr#1#2#3{\left(\/#1 #2\right)\!\mlquantified{#3}}
\def\mlforall{\mlquantifierabbr{\forall}}
\def\mlexists{\mlquantifierabbr{\exists}}
\def\mlunique{\mlquantifierabbr{\unique}}
\def\mlunique{\mlquantifierabbr{\unique}}
\def\mpexists#1{\paren{\mexists#1}}
\def\mpforall#1{\paren{\mforall#1}}
\def\mpunique#1{\paren{\munique#1}}
\def\tforall{\rotated{180}{A}}
\def\texists{\rotated{180}{E}}
%%}}}

%%{{{ booleans 
\def\True{\mathsf{True}}
\def\False{\mathsf{False}}
%%}}}

%%{{{ sets, relations, and functions 
\let\knuthsubset=\subset
\let\knuthsupset=\supset
\let\knuthsubseteq=\subseteq
\let\knuthsubsetneq=\subsetneq
\let\knuthsupseteq=\supseteq
\let\knuthsupsetneq=\supsetneq
\let\knuthnsubseteq=\nsubseteq
\let\knuthnsupseteq=\nsupseteq
\let\subset=\UNDEFINED
\let\subseteq=\UNDEFINED
\let\subsetneq=\UNDEFINED
\let\supset=\UNDEFINED
\let\supseteq=\UNDEFINED
\let\supsetneq=\UNDEFINED
\def\subset{\knuthsubseteq}
\def\supset{\knuthsupseteq}
\def\propersubset{\knuthsubsetneq}
\def\propersupset{\knuthsupsetneq}
\let\proper=\propersubset
\let\psubset=\propersubset
\let\psupset=\propersupset
\let\subsetneq=\propersubset
\let\supsetneq=\propersupset
\let\contains=\supset
\let\containd=\supset       % contain'd
\let\pcontains=\psupset
\let\pcontaind=\psubset
\def\nsubset{\smartnot\subset}
\def\nsupset{\smartnot\supset}
\def\notni{\smartnot\ni}
\def\nleq{\mathrel{\not\leq}}
\def\ngeq{\mathrel{\not\geq}}
\def\intersection{\cap}
\let\inter=\intersection
\def\Intersection{\bigcap}
\let\Inter=\Intersection
\def\union{\cup}
\def\Union{\bigcup}
\def\Unionl{\Union\nolimits}% same line
\def\Interl{\Inter\nolimits}% same line
\def\liml{\lim\nolimits}% same line
\let\limit=\liml
\let\liminflimits=\liminf
\let\limsuplimits=\limsup
\edef\liminf{\liminf\nolimits}
\edef\limsup{\limsup\nolimits}
\let\minus=\setminus
\def\overlim{\mathop{\overline{\lim}}}
\def\underlim{\mathop{\underline{\lim}}}
\let\olim=\overlim
\let\ulim=\underlim
\def\symdiff{\mathbin{\triangle}}
\def\surjto{\mathrel{\rightarrow\mkern-15mu\rightarrow}}
\let\surto=\surjto
\def\injto{\mathrel{\rightarrowtail}}
\def\bijto{\mathrel{\injto\mkern-15mu\rightarrow}}
\def\parto{\mathrel{\rightharpoonup}}
\def\ndeto{\mathrel{\rightsquigarrow}}
\def\decorateover#1#2{\mathrel{{\buildrel{#1} \over {#2}}}}
\def\to{\mathrel{\rightarrow}}
\def\from{\mathrel{\leftarrow}}
\def\longto{\mathrel{\mathord{-\mkern-8mu-\mkern-8mu\longrightarrow}}}
\def\longfrom{\mathrel{\mathord{\longleftarrow-\mkern-8mu-\mkern-8mu}}}
\def\toby#1{\mathrel{\decorateover{#1}{\mathord{-\mkern-8mu-\mkern-8mu\longrightarrow}}}}
\def\inctoby#1{\mathrel{\decorateover{#1}{\mathord{\incto}}}}
\def\longtoby#1{\mathrel{\decorateover{#1}{\mathord{\nrepeat 4 {-\mkern-8mu}\longrightarrow}}}}
\def\xlongtoby#1{\mathrel{\decorateover{#1}{\mathord{\nrepeat 12 {-\mkern-8mu}\longrightarrow}}}}
\def\fromby#1{\mathrel{\decorateover{#1}{\mathord{\longleftarrow\mkern-8mu-\mkern-8mu-}}}}
\def\longfromby#1{\mathrel{\decorateover{#1}{\mathord{\longleftarrow\nrepeat 4 {\mkern-8mu-}}}}}
\def\xlongfromby#1{\mathrel{\decorateover{#1}{\mathord{\longleftarrow\nrepeat 12 {\mkern-8mu-}}}}}
\def\reltoby#1{\mathrel{\decorateover{#1}{\mathord{-\mkern-8mu-\mkern-8mu\rightarrowtriangle}}}}
\def\relfromby#1{\mathrel{\decorateover{#1}{\mathord{\leftarrowtriangle\mkern-8mu-\mkern-8mu-}}}}
\let\rtoby=\reltoby
\let\rfromby=\relfromby
\let\ftoby=\toby
\let\ffromby=\fromby
\let\longmapsto=\knuthlongmapsto % save original longmapsto
\def\longmapsto{\mathrel{\cdopt{nodes={inner sep=0}} {} \ar[r, mapsto] \| {} \endcd}}
\def\longmapsfrom{\mathrel{\cdopt{nodes={inner sep=0}} {} \ar[r, mapsfrom] \| {} \endcd}}
\def\mapstoby#1{\mathrel{\cdopt{nodes={inner sep=0}} {} \ar[r, mapsto, "#1"] \| {} \endcd}}
\def\mapsfromby#1{\mathrel{\cdopt{nodes={inner sep=0}} {} \ar[r, mapsfrom, "#1"] \| {} \endcd}}
\def\bijtoby#1{\mathrel{\cdopt{nodes={inner sep=0}} {} \ar[r, tail, two heads, "#1"] \| {} \endcd}}
\def\injtoby#1{\mathrel{\cdopt{nodes={inner sep=0}} {} \ar[r, tail, "#1"] \| {} \endcd}}
\def\surtoby#1{\mathrel{\cdopt{nodes={inner sep=0}} {} \ar[r, two heads, "#1"] \| {} \endcd}}
\def\set#1{\left\{#1\right\}}
\def\fsset#1{\{#1\}}% fixed-size set
\def\bigset#1{{\mathopen{\big\{}{#1}\mathclose{\big\}}}}% forced big-size set
\def\tupa#1{\left\langle#1\right\rangle}
\def\tupp#1{\left(#1\right)}
\let\tup=\tupa
\def\proj#1{\pi_{#1}}% projections of implicit arity (pi-notation)
\def\projfrom#1#2{\pi^{#1}_{#2}}% projections of denoted arity (pi-notation)
\def\tproj#1{\namedfun{proj}_{#1}}% projections of implicit arity (proj-notation)
\def\tprojfrom#1#2{\namedfun{proj}^{#1}_{#2}}% projections of denoted arity (proj-notation)
\def\pproj#1#2{\paren{#2}_{#1}}% parenthesized projection via subscript
\DefFun fst
\DefFun snd
\DefFun swap
\DefFun outl
\DefFun outr
\DefFun inl
\DefFun inr
\let\knuthsucc=\succ% save original math symbol
\DefFun succ
\DefFun curry
\DefFun uncurry
\DefFun eval
\DefFun compose
\DefFun quot
\DefFun rem
\def\paren#1{{\left({#1}\right)}}
\def\nparen#1{{(\left.{#1}\right.)}}% forced normal-size parens
\def\lparen#1{{\left({#1}_{\vphantom ,}\right)}}% smart-large parens XXX
\def\bigparen#1{{\mathopen{\big(}{#1}\mathclose{\big)}}}% forced big-size parens
\def\Bigparen#1{{\mathopen{\Big(}{#1}\mathclose{\Big)}}}% forced Big-size parens
\def\biggparen#1{{\mathopen{\bigg(}{#1}\mathclose{\bigg)}}}% forced bigg-size parens
\let\funparen=\paren
\def\bracket#1{{\left[{#1}\right]}}
\def\bigbracket#1{{\mathopen{\big[}{#1}\mathclose{\big]}}}
\def\Bigbracket#1{{\mathopen{\Big[}{#1}\mathclose{\Big]}}}
\def\st{\;\mathord{\pmb{\mid}}\;}
\def\setst#1#2{\set{\,#1 \;\st\; #2\,}}% set such that
\def\setstt#1#2{\set{\,#1 \;\st\; \text{#2}\,}}% textmode in filter
\def\setlst#1#2{\set{\,#1 \ \;\middle|\;\  #2\,}}% sufficiently long such that
\def\setlstt#1#2{\set{\,#1 \ \;\middle|\;\  \text{#2}\,}}% + textmode in filter
\def\famst#1#2{{\paren{\,{#1} \,\st\, #2\,}}}
\def\family#1#2{{\paren{{#1}}_{#2}}}
\def\famil#1#2#3{{\family {{#1}_{#2}} {{#2}\in{#3}}}}
\def\faml#1#2{{\family {{#1}_{#2}} {{#2}}}}
\def\sequence#1#2{{\paren{#1}_{#2}}}
\def\seqn#1#2{\sequence {{#1}_{#2}} {#2}}
\def\seqnset#1#2{\set {{#1}_{#2}} {#2}}
\def\ssetp#1#2{({#1}\mathrel{;}{#2})}
\def\sseta#1#2{\langle{#1}\mathrel{;}{#2}\rangle}
\let\sset=\ssetp
\def\ssetfont{\cal}
\def\finsubset{\subset_{\text{\sixss fin}}}
\def\finpsubset{\psubset_{\text{\sixss fin}}}
\def\pset{{\wp}}
\def\psetfin{{\wp_{\text{\rm f}}}}
\let\powerset=\pset
\let\pfset=\psetfin
\def\psetp#1{\pset\funparen{#1}}
\def\card#1{\abs{#1}}
\def\eqof#1{\mathrel{=_{#1}}}
\def\id{\namedop{id}}
\def\idof#1{\mathord{\id}_{#1}}
\let\iddom=\idof
\def\idone{\mathord{1}}
\def\idoneof#1{\mathord{{\idone}_{#1}}}
\def\coim{\namedop{coim}}
\DefOp dom
\DefOp cod
\def\compose{\mathbin{\circ}}
\def\fcompose{\mathbin{\circ}}
\def\rcompose{\mathbin{\diamond}}
\def\dcompose{\mathbin{;}}
\let\rcom=\rcompose
\let\fcom=\fcompose
\let\dcom=\dcompose
\let\com=\compose
\def\trel#1{<<#1>>}
\def\mtrel#1{\text{<<#1>>}}
\def\relspace#1{\namedop{Rel}\funparen{#1}}
\def\reltype#1{\namedop{Rel}\funparen{#1}}
\def\eqrelspace#1{\namedop{EqRel}\funparen{#1}}
\def\eqreltype#1{\namedop{EqRel}\funparen{#1}}
\def\eqclass#1#2{\bracket{{#1}}_{#2}}
\def\eqclassalt#1#2{[\mathord{#1}\mathord{/}\mathord{#2}]}
\def\eqclassimp#1{[#1]}
\def\quoset#1#2{\mathord{#1}\mathord{/}\mathord{#2}}
\DefOp graph
\DefOp range
\DefOp domain
\def\funimg#1#2{#1\bracket{#2}}
\def\funpreimg#1#2{#1^{-1}\bracket{#2}}
\let\img=\funimg
\let\pre=\funpreimg
\let\rel=\mathrel
\def\relp#1{\rel{\paren{#1}}}
\let\of=\fcompose
\let\following=\compose
\def\lexp#1 to #2{\trdec{#1}{#2}}
\def\rexp#1 to #2{\tldec{#1}{#2}}
\def\liter#1#2{\trdec{#1}{#2}}
\def\riter#1#2{\tldec{#1}{#2}}
\def\literop#1#2#3{\trdec{#2}{\mathord{#1#3}}}
\def\riterop#1#2#3{\tldec{#2}{\mathord{#1#3}}}
\def\iter#1#2{\tldec{#1}{#2}}
\def\iterop#1#2#3{\tldec{#2}{\mathord{#1#3}}}
\def\incto{\mathrel{\hookrightarrow}}
\def\subsetto{\mathrel{\cdopt{nodes={inner sep=0}} {} \ar[r, hook, "\mathord{\subset}"] \| {} \endcd}}
\def\resto{\mathbin{\mkern-2mu\upharpoonright\mkern-1mu}}
\def\restosub#1{\mathord{|}_{#1}}
\def\resfun#1#2{{#1}\resto{#2}}
\def\resfunsub#1#2{{#1}\restosub{#2}}
\def\ton#1{\rel{\to^{#1}}}
\def\ifthenelse#1#2#3{\mathbf{if}~#1~\mathbf{then}~#2~\mathbf{else}~#3}
\def\pifthenelse#1#2#3{\paren{\ifthenelse{#1}{#2}{#3}}}
\def\IF#1\THEN#2\ELSE#3\FI{\ifthenelse{#1}{#2}{#3}}
\def\PIF#1\THEN#2\ELSE#3\FIP{\pifthenelse{#1}{#2}{#3}}
\def\mapsio#1#2{\paren{#1\mapsto#2}}% maps input (#1) to output (#2)
\def\lamhead#1{{\lambda}{#1}}% just the head without any body
\def\lam#1#2{\lamhead{#1}\,.\,{#2}}
\def\lamt#1#2{\lam{#1}{\text{#2}}}
\def\lamp#1#2{\lam{#1}{\paren{#2}}}% parenthesize body
\def\plam#1#2{\nparen{\lam{#1}{#2}}}% parenthesize whole term
\def\plamt#1#2{\nparen{\lamt{#1}{#2}}}
\def\plamp#1#2{\nparen{\lamp{#1}{#2}}}
\def\lapp{\nobreak\;\nobreak}% lambda term application
\def\fapp{\nobreak\;\nobreak}% function application
\def\at{\mathbin{\@}}% function application explicit infix
\let\fat=\at
\def\lappp#1{\lapp\paren{#1}}% parenthesized arg lapp
\def\fappp#1{\fapp\paren{#1}}% parenthesized arg fapp
\let\fa=\fapp
\let\fap=\fappp
\let\la=\lapp
\let\lap=\lappp
\def\descrsym{\iota}
\def\descr#1#2{\descrsym\,{#1}\,.\,{#2}}
\def\bag#1{\mathord{\Lbag#1\Rbag}}
\def\inbag{\mathrel{\knuthvarepsilon}}
\def\bagunion{\mathbin{\Cup}}
\def\baginter{\mathbin{\Cap}}
\def\bagplus{\mathbin{\oplus}}
\def\notinbag{\mathrel{\mkern-2mu\not{\mkern-3mu\knuthvarepsilon}}}
\def\subbag{\mathrel{\Subset}}
\def\notsubbag{\mathrel{\not\Subset}}
\def\emptybag{\bag{\mkern-3mu}}
\def\finv#1{{#1}^{-1}}
\def\finvp#1{\finv{\paren{#1}}}
\def\rinv#1{\rel{{#1}^{-1}}}
\def\rinvp#1{\rinv{\paren{#1}}}
\def\rop#1{\rel{{#1}^{\partial}}}
\def\ropp#1{\rop{\paren{#1}}}
\def\frel#1{\approx_{#1}}
\def\relto{\mathbin{\rightarrowtriangle}}
\def\relfrom{\mathbin{\leftarrowtriangle}}
\let\rto=\relto
\let\fto=\to
\def\refclosure#1{\mathrel{{#1}_{\textrm{r}}}}
\def\symclosure#1{\mathrel{{#1}_{\textrm{s}}}}
\def\transclosure#1{\mathrel{{#1}_{\textrm{t}}}}
\def\reftransclosure#1{\mathrel{{#1}_{\textrm{rt}}}}
\let\rclosure=\refclosure
\let\sclosure=\symclosure
\let\tclosure=\transclosure
\let\rtclosure=\reftransclosure
\def\rclo#1{\mathrel{{#1}^{=}}}
\def\sclo#1{\mathrel{{#1}^{\leftrightarrow}}}
\def\tclo#1{\mathrel{{#1}^{+}}}
\def\rtclo#1{\mathrel{{#1}^{*}}}
\def\cclo#1{\mathrel{{#1}^{\circ}}}
\def\reclo#1{\mathrel{{#1}^{\triangleleft}}}
\def\leclo#1{\mathrel{{#1}^{\triangleright}}}
\def\transcl#1{\decorateover{+}{#1}}
\def\rtranscl#1{\decorateover{*}{#1}}
\def\symcl#1{\decorateover{\leftrightarrow}{#1}}
\def\refcl#1{\decorateover{=}{#1}}
\def\cross{\times}
\def\funspace#1#2#3{\mathord{\paren{#1 #2 #3}}}% funspace: set of #2 functions from #1 to #3
\def\funs#1#2{\funspace{#1} \to    {#2}}
\def\injs#1#2{\funspace{#1} \injto {#2}}
\def\surs#1#2{\funspace{#1} \surto {#2}}
\def\bijs#1#2{\funspace{#1} \bijto {#2}}
\def\pars#1#2{\funspace{#1} \parto {#2}}
\def\fpair#1#2{\mathord{\tup{#1,#2}}}
\def\fcross#1#2{\mathord{#1\cross#2}}% function-like (prefix) \cross
\def\pfcross#1#2{\mathord{\paren{#1\cross#2}}}
\def\diag{\Delta} % diagonal
\def\diagdom#1{\diag_{#1}}
\def\chr#1{\chi_{#1}}
\def\chrdom#1#2{\chr{#2}^{#1}}
\def\kon#1{\namedop{k}_{#1}}
\def\kondom#1#2{\kon{#2}^{#1}}
\def\kondomcod#1#2#3{\kon{#3}^{#1,#2}}
\def\inc{\imath}
\def\incofin#1#2{\inc_{{#1}\incto{#2}}}
\def\evaldc#1#2{\eval_{{#1}\to{#2}}}
\def\composeftt#1#2#3{\mathbin{\compose_{{#1}\to{#2}\to{#3}}}}% from-to-to
\let\comftt=\composeftt
\let\oflab=\composeftt
\def\app{\nobreak\,\nobreak}
%%}}}

%%{{{ lambda calculus 
\def\Llam#1#2{\lambda\,{#1}\,.\,{#2}}
\def\Lmac#1{\underline{\mathtt{#1}}}
\def\Lfinto{\rightarrow\mathrel{\kern-.8em}\rightarrow}
\def\Lnum#1{{\underline{#1}}}
\def\lamstep{\mathrel{\;\triangleright_{\kern-.4em}{}_{\phantom{\beta}}\;}}
\def\invstep{\phantom{\lamstep}}
\def\betastep{\mathrel{\;\triangleright_{\kern-.4em{}_\beta}\;}}
\def\etastep{\mathrel{\;\triangleright_{\kern-.4em{}_\eta}\;}}
\def\alphastep{\mathrel{\;\triangleright_{\kern-.4em{}_\alpha}\;}}
\let\lstep=\lamstep
\let\istep=\invstep
\let\bstep=\betastep
\let\estep=\etastep
\let\astep=\alphastep
\def\lameq{\mathrel{\,=\,}}
\def\isteq{\istep\lameq}% istep-indent equals
\def\redex#1{\underline{#1}}
%%}}}

%%{{{ combinatory logic 
\def\C#1{{\mathord{\mathsfmbf{#1}}}}
\def\Cto{\mathrel{\triangleright}}
\def\cI{{\C I}}
\def\cK{{\C K}}
\def\cM{{\C M}}
\def\cC{{\C C}}
\def\cS{{\C S}}
\def\cW{{\C W}}
\def\cB{{\C B}}
\def\cR{{\C R}}
\def\cV{{\C V}}
\def\cBp{{{\C B}'}}
%%}}}

%%{{{ set theory 
\let\knuthsetminus=\setminus
\def\setminus{\mathbin{\knuthsetminus}}
\def\cantorcard#1{\overline{\overline{#1}}}
\def\cantorset{{\frak C}}
\def\continuum{\euf{c}}
\def\finord#1{\overline{#1}}
\def\eqc{\mathrel{=_{\namedop{c}}}}
\def\neqc{\mathrel{\not\eqc}}
\def\leqc{\mathrel{\leq_{\namedop{c}}}}
\def\geqc{\mathrel{\geq_{\namedop{c}}}}
\def\gtc{\mathrel{>_{\namedop{c}}}}
\def\ltc{\mathrel{<_{\namedop{c}}}}
\def\Univ{{\bbb V}}
\def\complement#1{\widetilde{#1}}
\let\compl=\complement
\def\russell#1{{\mathbf{r}(#1)}}
\def\metain{\mathrel{\in\kern-0.425em\in}}
\let\inclass=\metain
\def\classst#1#2{\pmbb{\{}\;{#1}\;\st \;{#2}\;\pmbb{\}}}
\def\classstt#1#2{\pmbb{\{}\;{#1}\;\st \;{\text{#2}}\;\pmbb{\}}}
\def\classimg#1#2{{#1}{\pmbb[}\,{#2}\,{\pmbb]}}
\let\clsimg=\classimg
\def\universet{{\cal U}}
\DefRel Eq
\DefRel Set
\DefRel Singleton
\DefRel Doubleton
\DefRel Empty
\DefRel Universal
\DefRel Pair
\DefRel Function
\DefRel Relation
\DefRel Infinite
\DefFun first
\DefFun second
\def\kurpair#1#2{\set{\set{#1}, \set{{#1}, {#2}}}}
\def\disjunion{\mathbin{\uplus}}
\def\Disjunion{\mathop{\biguplus}}
\let\dunion=\disjunion
\let\Dunion=\Disjunion
\def\setsucc#1{{#1}{}^+}
\def\kleenestar#1{{#1}^\star}
\def\kleenestarp#1{\paren{#1}^\star}
\let\kstar=\kleenestar
\let\kstarp=\kleenestarp
%%}}}

%%{{{ foundational systems and theories 
\DefFou ZF
\DefFou ZFC
\DefFou AC
\DefFou DC
\DefFou ZFDC
\DefFou NBG
\DefFou NF
\DefFou MK
\DefFou CZF
\DefFou IZF
\DefFou MLTT
\DefFou HoTT
\DefFou ETCS
\DefFou CL
\def\ACN{\mathord{\AC}_\nats}
%%}}}

%%{{{ type theory 
\def\type#1{{\namedtype{#1}}}
\DefType Nat
\def\oftype{\mathrel{:}}
\let\is=\oftype
\def\namedrule#1{{\scshape #1}}
\def\rulelabel#1{{\smaller\scshape #1}}
%%}}}

%%{{{ category theory 
\def\cat#1{{\mathsfmbf {#1}}}
\def\one{{\mathit 1}}
\def\oneof#1{{\one_{#1}}}
\DefOpP Obj
\DefOpP Arr
\DefOp Hom
\DefOp src
\DefOp tgt
\DefCAT SET         Set
\DefCAT INTLEQ      IntLeq
\DefCAT INTDIV      IntDiv
\DefCAT GROUP       Group
\DefCAT ABEL        Abel
\DefCAT RING        Ring
\DefCAT LATTICE     Lattice
\DefCAT POINTEDSET  PointedSet
\DefCAT POSET       Poset
%%}}}

%%{{{ order theory 
\let\bottom=\bot
\def\smallcovby{\mathrel{-\mkern-8mu\Yleft}}
\def\covby{\mathrel{-\mkern-9mu<}}
\def\wellbelow{\mathrel{\ll}}
\let\wbelow=\wellbelow
\def\incomparable{\doublemidrel}
\def\altincomparable{\mathrel{\rangle\mkern-5mu\langle}}
\let\incomp=\incomparable
\def\embto{\mathrel{\hookrightarrow}}
\def\embijto{\hookrightarrow\mathrel{\mkern-15mu}\rightarrow}
\def\dmnd{\mathbin{\diamond}}
\def\join{\mathbin{\vee}}
\def\meet{\mathbin{\wedge}}
\def\Join{\bigvee}
\def\Meet{\bigwedge}
\def\downsets#1{\cal O(#1)}
\let\downs=\downsets
\def\down{\mathord{\downarrow}}
\def\up{\mathord{\uparrow}}
\def\dualposet#1{{#1}^\partial}
\let\dual=\dualposet
\def\ubs#1{{#1}^{\mathrmtiny{U}}}
\def\lbs#1{{#1}^{\mathrmtiny{L}}}
\def\lub{\namedop{lub}}
\def\glb{\namedop{glb}}
\def\fixpoints{\namedop{Fix}}
\def\lfp{\namedop{lfp}}
\def\gfp{\namedop{gfp}}
\def\lift#1{#1_{\bot}}
\def\posetplus{\oplus}
\def\posetunion{\uplus}
\def\ordplus{\oplus}
\def\ordinal#1{\mathbf{#1}}
\let\ordnum=\ordinal
\def\flatnum#1{\overline{\mathbf{#1}}}
%%}}}

%%{{{ group theory 
\def\go{\mathbin{\pmb{\cdot}}}
\def\gop#1{{#1}^{\mathrmtiny{op}}}
\def\gopp#1{\gop{\paren{#1}}}
\def\quogroup#1#2{\quoset{#1}{#2}}
\let\quogrp=\quogroup
\def\gord#1{\mathord{o}\funparen{#1}}
\def\tord#1{\namedop{ord}\funparen{#1}}
\def\bord#1{\abs{#1}}
\def\gid{\mathord{e}}
\def\gidof#1{\mathord{e_{#1}}}
\def\ginv#1{{#1}^{-1}}
\def\ginvp#1{\ginv{\paren{#1}}}
\def\ginvt{\namedfun{inv}}
\def\ginvtof#1{\mathord{\namedfun{inv}_{#1}}}
\def\ima{\namedop{im}}
\def\sym#1{S_{#1}}
\def\dih#1{{{\cal D}_{#1}}}
\def\dihalt#1{{\mathrm{Dih}_{#1}}}
\makeatletter
\def\pmodL#1{\allowbreak \ifinner \mkern 8mu\else \mkern 18mu\fi ({\fam \z@ mod_{L}}\,\,#1)}
\def\pmodR#1{\allowbreak \ifinner \mkern 8mu\else \mkern 18mu\fi ({\fam \z@ mod_{R}}\,\,#1)}
\makeatother
\def\gconj#1{\sigma_{#1}}
\def\gconjrel{\approx}
\def\gcl#1{\namedop{Cls}\funparen{#1}}
\let\groupord=\gord
\def\subgroup{\leq}
\def\nsubgroup{\nleq}
\let\subgrp=\subgroup
\let\nsubgrp=\nsubgroup
\def\generate#1{\left\langle#1\right\rangle}
\let\gen=\generate
\def\normalsubgroup{\mathrel{\trianglelefteq}}
\let\normal=\normalsubgroup
\def\nnormalsubgroup{\mathrel{\smartnot{\trianglelefteq}}}
\let\nnormal=\nnormalsubgroup
\def\cosetsL#1{{\cal L}_{#1}}
\def\cosetsR#1{{\cal R}_{#1}}
\def\cosetsLin#1#2{{\cal L}_{#1}^{#2}}
\def\cosetsRin#1#2{{\cal R}_{#1}^{#2}}
\def\congL#1{\mathrel{{}_{#1}{\cong}}}
\def\congR#1{\mathrel{\cong_{#1}}}
\DefOp Hom
\DefOp End
\DefOp Aut
\DefOp Inn
\DefOp Out
\def\groupind#1#2{\left|\mathord{#1}\mathbin{:}\mathord{#2}\right|}
\def\altgroupind#1#2{i_{#1}(#2)}
\def\centralizer#1{{\namedop Z}(#1)}
\def\normalizer#1{{\namedop N}(#1)}
\def\centralizerin#1#2{{\namedop Z}_{#1}(#2)}
\def\normalizerin#1#2{{\namedop N}_{#1}(#2)}
\let\centizer=\centralizer
\let\normizer=\normalizer
\let\cizer=\centizer
\let\nizer=\normizer
\let\centizerin=\centralizerin
\let\normizerin=\normalizerin
\let\cizerin=\centizerin
\let\nizerin=\normizerin
\def\gcenter#1{\cizer{#1}}
\def\actorL#1{\mathord{\paren{#1\uhole}}}% Left
\def\actorR#1{\mathord{\paren{\uhole#1}}}% Right
\def\actorS#1#2{\mathord{\paren{#1\uhole#2}}}% Stereo
%%}}}

%%{{{ linear algebra 
\def\veca#1{\vec#1}
\def\vecb#1{\mathbf#1}
%%}}}

%%{{{ structured sets 
\def\carrier#1{\left|#1\right|}
\def\isomorphic{\mathrel{\knuthcong}}
\let\iso=\isomorphic
\def\bangto{\mathrel{\cdopt{cramped, nodes={inner sep=0}} {} \ar[r, "!"] \| {} \endcd}}
\def\isomorphismto{\mathrel{\cdopt{cramped, nodes={inner sep=0}} {} \ar[r, "\mathord{\isomorphic}"] \| {} \endcd}}
\let\isoto=\isomorphismto
\let\uniqueto=\bangto
\let\uto=\uniqueto
\def\homto{\mathrel{\cdopt{nodes={inner sep=0}} {} \ar[r, "\mathrmtiny{hom}"] \| {} \endcd}}
\def\dotop{\mathbin{\cdot}}
\def\invr#1{\ulabR{#1}}
\def\invl#1{\ulabL{#1}}
\def\idr{\dlabR{\mathit{1}}}
\def\idl{\dlabL{\mathit{1}}}
%%}}}

%%{{{ placeholder hole 
\definecolor{holecolor}{cmyk}{.25,.05,.05,0}
\def\hole{{\ensuremath{\colorbox{holecolor}{$\phantom{x}$}}}}
\def\dhole{{\mathord{-}}}
\def\bhole{{\mathord{\bullet}}}
\def\uhole{{\mathord{\_}}}
\def\thole{\thinspace\vrule height 0.0pt depth 0.4pt width 1em\thinspace}
\def\lthole{\thinspace\vrule height 0.0pt depth 0.4pt width 2em\thinspace}
\def\xlthole{\thinspace\vrule height 0.0pt depth 0.4pt width 4em\thinspace}
\def\askhole{{\thole?\thole}}
\def\asklhole{{\lthole?\lthole}}
\def\askbox{{\holed ?}}
\def\namedhole#1{\text{\thole$#1$\thole}}
\def\holed#1{{\ensuremath{\colorbox{holecolor}{$#1$}}}}
\def\dotswithsome#1{\dots#1\dots#1\dots}
\def\holewithsome#1{\lthole#1\lthole#1\lthole}
%%}}}

%%{{{ strings 
\def\concat{\mathbin{+\mkern-8mu+}}
%%}}}

%%{{{ algorithms 

\def\algorithmstylize#1{\text{{\scshape #1}}}

%TODO: get rid off this
\def\algospec INPUT: #1 OUTPUT: #2\endspec{%
\halign{%
\hfil##&##\hfil\cr
\casestylize{\algoinputname:}  & #1\cr
\casestylize{\algooutputname:} & #2\cr
}
}

%%}}}

%%{{{ code 
\def\code#1{\mathtt{#1}}
%%}}}

%%{{{ numerical 
\def\digit#1{\text{\sf #1}}
\def\numeral#1{\underline{\text{\sf #1}}}
%%}}}

%%{{{ complex numbers 
\def\modulus#1{\left|#1\right|}
%%}}}

%%{{{ analysis 
\def\norm#1{\left\Vert#1\right\Vert}
\def\limto{\mathrel{\to}}
\let\tendsto=\limto
\let\tends=\tendsto
\def\nlimto{\smartnot{\limto}}
\let\ntendsto=\nlimto
\let\ntends=\ntendsto
\def\convexhull#1{\left\langle#1\right\rangle}
\let\hull=\convexhull
\def\ballsym{{\cal B}}
\def\ball#1#2{\ballsym_{#1}\funparen{#2}}
\def\ballm#1#2#3{\ballsym^{#1}_{#2}\funparen{#3}}
\def\cball#1#2{\ballsym^{\mathord{\leq}#1}\funparen{#2}}
\def\cballm#1#2#3{\ballsym^{#1}_{\mathord{\leq}#2}\funparen{#3}}
\def\nbhd#1{\cal N_{#1}}
\let\hood=\nbhd
\def\deriv{\mathord{\mathrm{D}}}
\def\riemannables#1#2{\mathord{\mathrm{R}\bracket{#1,#2}}}
\def\diffables#1{\mathord{\mathrm{C}^{#1}}}
\def\smooths{\diffables\infty}
\def\analytics{\diffable\omega}
\def\intbv#1#2#3#4{\int_{#1}^{#2}{#3}\,\mathsl{d}{#4}}% bound & var: int from #1 to #2 of #3 as a fun of the var #4
\DefOpP length
%%}}}

%%{{{ topology 
\def\derived#1{#1'}
\def\interior#1{#1^\smile}
\def\closure#1{#1^\frown}
\let\deri=\derived
\let\inte=\interior
\let\clos=\closure
\let\cmpl=\compl
\DefOP interiort   inte
\DefOP closuret    clos
\DefOP complementt compl
\DefOP derivedt    deriv
\def\topobyns#1{\cal O_{#1}}% topology generated by a nbhd system (#1)
\def\hoodsofp#1#2{{#1}\funparen{#2}}% hood system of a point
\def\toposep#1{{\ensuremath{\mathrm T_{#1}}}}
\def\subtopo{\leq}
\def\hoodscross{\otimes}
\def\topocross{\times}
%%}}}

%%{{{ repl/givens/goals table 
% XXX: the whole implementation has grown too complex/ugly
% TODO: reimplement / simplify

\Newskip repl=.666\bigskipamount;

\definecolor{replcomment}{cmyk}{0.888,.333,.888,0}
\definecolor{replmeaning}{cmyk}{0.888,.333,.888,0}
\DefStyle replcomment {\color{faded}}
\DefStyle replfaded {\color{faded}}
\DefStyle replR {\aRstyle}
\DefStyle replG {\aGstyle}
\DefStyle replB {\aBstyle}

\def\replalertstyle{\ifreplignorealerts\else\alertstyle\fi}

\newcount\repllineno
\newif\ifrepllabline
\newif\ifreplhidelineno
\newif\ifreplmath
\newif\ifreplalert
\newif\ifreplcross
\newif\ifreplmeaning
\newif\ifreplcomputation
\newif\ifreplcontinuation
\newif\ifreplskipcount
\newif\ifreplignorealerts
\newif\ifreplphantom
\newif\ifreplhide

% TODO: XXX: a better implementation would have \replhandleopts and \replhandleopt
% TODO: XXX: fix bools: they are mixed (too much!) in and out of thisrepllinestyles

\def\replhandleopts#1{%
\def\thisrepllinestyles{}%
\WhenStrContains{#1}{-}{\addto\thisrepllinestyles{\replcommentstyle}}%
\WhenStrContains{#1}{a}{\replalerttrue\addto\thisrepllinestyles{\replalertstyle}}%
\WhenStrContains{#1}{f}{\addto\thisrepllinestyles{\replfadedstyle}}%
\WhenStrContains{#1}{R}{\addto\thisrepllinestyles{\replRstyle}}%
\WhenStrContains{#1}{G}{\addto\thisrepllinestyles{\replGstyle}}%
\WhenStrContains{#1}{B}{\addto\thisrepllinestyles{\replBstyle}}%
\WhenStrContains{#1}{c}{\replcomputationtrue}%
\WhenStrContains{#1}{,}{\replcontinuationtrue}%
\WhenStrContains{#1}{t}{\addto\thisrepllinestyles{\replmathfalse}}%
\WhenStrContains{#1}{m}{\addto\thisrepllinestyles{\replmathtrue}}%
\WhenStrContains{#1}{/}{\addto\thisrepllinestyles{\replcrosstrue}}%
\WhenStrContains{#1}{=}{\addto\thisrepllinestyles{\replmeaningtrue}}%
\WhenStrContains{#1}{x}{\replphantomtrue}%
\WhenStrContains{#1}{X}{\replhidetrue}%
}

\newbox\replmaxscript
\newbox\replmaxgiven
\newbox\replmaxgoal
\newdimen\replscriptwidth
\newdimen\replgivenswidth
\newdimen\replgoalswidth

\def\setreplmaxscript#1{\global\setbox\replmaxscript\hbox{#1}\global\replscriptwidth=\wd\replmaxscript}
\def\setreplmaxgiven#1{\global\setbox\replmaxgiven\hbox{#1}\global\replgivenswidth=\wd\replmaxgiven}
\def\setreplmaxgoal#1{\global\setbox\replmaxgoal\hbox{#1}\global\replgoalswidth=\wd\replmaxgoal}

\def\replline#1:#2 #3; {% opts:lab body
% init bools
\replskipcountfalse
\replcontinuationfalse
\replcomputationfalse
\replphantomfalse
\replhidefalse
\repllablinefalse
% handle opts
\replhandleopts{#1}%
\ifreplphantom \def\repllinebody{\phantom{#3\unskip}}%
\else          \def\repllinebody{#3\unskip}%
\fi
\ifvanishes#2\\\else\repllablinetrue\fi
% implications
\ifreplcontinuation\replskipcounttrue\fi
\ifreplphantom\replskipcounttrue\fi
\ifreplhide\replskipcounttrue\fi % redundant at the moment
% start
\ifreplhide
\else
\ifreplskipcount
\else
\global\advance\repllineno by 1\relax
\ifreplhidelineno\else\llap{\color{faded}\sizeix\sf\the\repllineno\quad\ \ }\fi
\fi % /ifreplskipcount
{%
\let~=\OLDTILDE
\thisrepllinestyles
\ifreplcomputation
\quad$\computed { \\ \repllinebody }$
\relax
\else
\ifreplcontinuation\quad\fi\repllinebody%
\fi % \ifreplcomputation
}%
\ifrepllabline\labline[#2=\the\repllineno]\fi
\cr
\fi % /ifreplhide
}

\def\replggline#1:#2 #3; {% opts:lab body (lab does nothing here)
\replhandleopts{#1}%
\ifreplphantom \def\repllinebody{\phantom{#3\unskip}}%
\else          \def\repllinebody{#3\unskip}%
\fi
\ifreplhide
\else
{%
\let~=\OLDTILDE
\thisrepllinestyles
\ifreplcross
  \ifreplalert
    \ifreplmath $\coloredcancel{red}{\repllinebody}$
    \else       $\coloredcancel{red}{\text{\repllinebody}}$
    \fi
  \else % (not replalert)
    \ifreplmath $\coloredfbcancel{black}{black}{\repllinebody}$
    \else       $\coloredfbcancel{black}{black}{\text{\repllinebody}}$
    \fi
  \fi % /ifreplalert
\else % (not replcross)
  \ifreplmeaning
    $\mathcoled{ &\ \raise-.5ex\hbox{$\coloredvmeans{replmeaning}$} \\
                 &\color{replmeaning}\!\ifreplmath\repllinebody\else\text{\repllinebody}\fi \\}$
  \else % (not replmeaning) (this is the "plain" case)
    \ifreplmath$\repllinebody$\else\repllinebody\fi
  \fi % /ifreplmeaning
\fi % /ifreplcross
}%
\procruster\cr
\fi % /ifreplhide
}

\def\replpadding{\hglue .666em\relax}
\def\replvrule{{\color{veryfaded}\vrule width .333em\relax}}
\def\replhrule{\noalign{{\color{veryfaded}\hrule depth .333pt\relax}}}
\def\replggvrule{{\color{veryfaded}\vrule width .333pt\relax}}

\def\replshownum{\global\replhidelinenofalse}
\def\replhidenum{\global\replhidelinenotrue}

\def\replscript #1\endreplscript{%
\ifreplhidelineno\def\restorereplhidelineno{\global\replhidelinenotrue}%
\else            \def\restorereplhidelineno{\global\replhidelinenofalse}%
\fi
{%
\global\repllineno=0\relax
\let\li=\replline
\let\shownum=\replshownum
\let\hidenum=\replhidenum
\let\OLDTILDE=~%
\def\qed{\hfill\ensuremath{\qedsymbol}}%
\def~{\li}%
\ifdim\replscriptwidth>0pt\halign to \replscriptwidth\else\halign\fi { ##\hfil \cr
{\bf \sayName{proof}}\strut\cr
\replhrule\cr
#1%
}
}%
\restorereplhidelineno
}

\def\givens#1\endgivens{%
{%
\global\replmathtrue
\global\replignorealertsfalse
\def\inmath{\global\replmathtrue}%
\def\intext{\global\replmathfalse}%
\let\li=\replggline
\let\OLDTILDE=~%
\def~{\li}%
\ifdim\replgivenswidth>0pt\halign to \replgivenswidth\else\halign\fi { ##\hfil \cr
{\bf \sayName{givens}}\strut\cr
\replhrule\cr
#1%
}
}%
}

\def\goals#1\endgoals{%
{%
\global\replmathtrue
\global\replignorealertsfalse
\def\inmath{\global\replmathtrue}%
\def\intext{\global\replmathfalse}%
\let\li=\replggline
\let\OLDTILDE=~%
\def~{\li}%
\ifdim\replgoalswidth>0pt\halign to \replgoalswidth\else\halign\fi { ##\hfil \cr
{\bf \sayName{goals}}\strut\cr
\replhrule\cr
#1%
}
}%
}

\def\repltable\givens#1\goals#2\endrepltable{%
{%
\eop\replskip\noi
\hbox to \hsize {%
\hfil
\replvrule
\replpadding
\vtop{\givens#1\endgivens}%
\hfil
\replggvrule
\hfil
\vtop{\goals#2\endgoals}%
\replpadding
\replvrule
\hfil
}
}%
\eop\replskip\noi
}

\def\replproof#1\endreplproof{%
{%
\eop\replskip\noi
\hbox to \hsize {%
\hfil
\replvrule
\replpadding
\vtop{\replscript#1\endreplscript}%
\replpadding
\replvrule
\hfil
}
}%
\eop\replskip\noi
}

\def\repl #1\givens#2\goals#3\endrepl{%
{%
\eop\replskip\noi
\hbox to \hsize {%
\replvrule
\replpadding
\vtop{\replscript#1\endreplscript}%
\replpadding
\hfil
\replvrule
\replpadding
\vtop{\givens#2\endgivens}%
\replpadding
\replggvrule
\replpadding
\vtop{\goals#3\endgoals}%
\replpadding
\replvrule
}
}%
\eop\replskip\noi
}

\def\repls #1\endrepls{%
\begingroup
\replscriptwidth=0pt\relax
\replgivenswidth=0pt\relax
\replgoalswidth =0pt\relax
% XXX: restorerepls... here, not restorerepl...
\ifreplhidelineno\def\restorereplshidelineno{\global\replhidelinenotrue}%
\else            \def\restorereplshidelineno{\global\replhidelinenofalse}%
\fi
\let\shownum=\replhidenum
\let\hidenum=\replhidenum
\def\maxproof##1: ##2; {\IfStrContains {##1} {m} {\setreplmaxscript{$##2$}} {\setreplmaxscript{##2}}}%
\def\maxgiven##1: ##2; {\IfStrContains {##1} {t} {\setreplmaxgiven {##2}}   {\setreplmaxgiven {$##2$}}}%
\def\maxgoal ##1: ##2; {\IfStrContains {##1} {t} {\setreplmaxgoal  {##2}}   {\setreplmaxgoal  {$##2$}}}%
#1%
\restorereplshidelineno
\endgroup
}

%%}}}

\endinput

Notes:

\math .. \endmath
for simple math stuff, uses gather so it understands \\

\longmath .. \endlongmath
for math that's too long for a single line (break with \\), uses multline

\mathcol ..\endmathcol
makes a single (\alignat 1) r/l-columnblock

\mathcols n .. \endmathcols
makes n (\xalignat n) r/l-columnblocks, justly spaced

\mathxcols n .. \endmathcols
makes n (\xxalignat n) r/l-columnblocks, maximally spaced

\mathtightcols n .. \endmathtightcols
makes n (\alignat n) r/l-columnblocks, minimally spaced (tight)

\mathcall .. \endmathcall
r/l-columnblock that supports \called:
\lfp f &\defeq \min(\fixpoints f)  \called {the \dterm{least fixpoint} of $f$} \\

-ed versions: mathed, mathcoled, mathcolsed, computed
They get their main argument non-delimited:
\computed { ... }
\mathcolsed 12 { ... }

\context lr % <- l/r must be t/m, corresponding to left and right default mode
\x this: \reals ;
\x this: \reals \mtag[spot=*];
\endcontext

note that you must stick the \*tag to ;
(this is terrible)


# repls

example:

\repl
~    : Let $f : A \to B$. ;
~a   : Let $x$ be a real number. ;
\givens
~    : x : \Nat ;
~   t: $n$ ímpar ;
~   =: \lexists {k \in \ints} {n = 2k+1} ;
\goals
~a / : coisa ;
\endrepl

To label some line of repl use  :foo  just like with \li's of lists.
To refer to it: \refline[foo].

proof part macros: \hidenum \shownum
   gg part macros: \intext \inmath

use \replproof .. \endreplproof when you need just the script part
use \repltable .. \endrepltable when you need just the Givens/Goals table

options for repl/gg lines:
  -: comment
  f: faded (unfocused)
  a: alert
  R: red
  G: green
  B: blue
  ,: continuation line
  x: phantom
  X: don't show at all

options for repl lines only:
  c: computed
  s: skip number (when \shownum)

options for gg lines only:
  t: this one in text
  m: this one in math
  /: cancel out
  =: meaning of above

