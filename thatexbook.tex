%%{{{ [vim] 
%% vim:foldmarker=%{{{,%}}}
%% vim:foldmethod=marker
%% vim:foldcolumn=6
%%}}}
%% thatexbook.tex
%% author: Thanos Tsouanas <thanos@tsouanas.org>

%%{{{ frontmatter 

%%{{{ \WRITE*TOCENTRY
% XXX: Wrapper hacking around eplain's \write*tocentry
\def\WRITENUMBEREDTOCENTRY#1#2#3{%
\edef\TOCITEMCLASS{{#1}}%
\edef\TOCITEMTITLE{{#2}}%
\edef\TOCITEMNO{\number#3}%
\ea\ea\ea\writenumberedtocentry\ea\TOCITEMCLASS\TOCITEMTITLE{\TOCITEMNO}%
}
\def\WRITETOCENTRY#1#2{%
\edef\TOCITEMCLASS{{#1}}%
\edef\TOCITEMTITLE{{#2}}%
\ea\ea\ea\writetocentry\ea\TOCITEMCLASS\TOCITEMTITLE%
}
%%}}}

%%{{{ short toc 
\def\printshorttoc{{
\oddpage\titlepagetrue
\baselineskip=18pt
\def\tocchapterentry##1##2##3{\smallskip{\line{\llap{{\chapterthe{##2}}.~}##1\dotfill\hlprintpage{##3}}}}
\def\tocappendixentry##1##2##3{\smallskip{\line{\llap{{\appendixthe{##2}}.~}##1\dotfill\hlprintpage{##3}}}}
\def\tocchapblahentry##1##2{\smallskip{\line{##1\dotfill\hlprintpage{##2}}}}
\def\tocwhereentry##1##2{{\leftingmargin {2em} \color{wheretoccolor}\nineit ##1\endleftingmargin}}
\def\tocsectionentry##1##2##3{}
\def\tocsecblahentry##1##2{}
{\larger\bf
\parindent=0pt
\baselineskip=16pt
\centerline{\fourteenrm\toupper{\shorttocterm}}
\chaptitleskip
\readtocfile
}
\vfil
\eject
}}
%%}}}

%%{{{ long toc 
\def\printlongtoc{{
\oddpage
\titlepagetrue
\nodecorspage
\def\tocchapterentry    ##1##2##3{{\bf\vskip 2ex\line{\llap{{\chapterthe{##2}}.~}##1\enspace\hrulefill\enspace\hlprintpage{##3}}}\vskip 1ex}
\def\tocappendixentry   ##1##2##3{{\bf\vskip 2ex\line{\llap{{\appendixthe{##2}}.~}##1\enspace\hrulefill\enspace\hlprintpage{##3}}}\vskip 1ex}
\def\tocchapblahentry   ##1##2{{\bf\vskip 2ex\line{##1\enspace\hrulefill\enspace\hlprintpage{##2}}}\vskip 1ex}
\def\tocwhereentry      ##1##2{}
\def\tocsectionentry    ##1##2##3{{\line{{\qquad} \llap{\secdecoratetag{\secthe{##2}}. }{##1}{\dotfill}{\hlprintpage{##3}}\qquad\qquad}}}
\def\tocsecblahentry    ##1##2{{\line{{\qquad} {##1}{\dotfill}{\hlprintpage{##2}}\qquad\qquad}}}
{
\parindent=0pt
\centerline{\fourteenrm\toupper{\tocterm}}
\chaptitleskip
\readtocfile
}
\vfil
\eject
}}
%%}}}

%%{{{ list of algorithms 
\def\printloa{{% TODO
\chapblah \loaterm:

\endchapblah
}}
%%}}}

%%{{{ list of code 
\def\printloc{{% TODO
\chapblah \locterm:

\endchapblah
}}
%%}}}

%%}}}

%%{{{ appendix printers  

%%{{{ \printpartpage 
\def\printpartpage#1{{%
\partpage
\hbox{}\vfil
\twentyfourbf
\centerline{#1}
\titlepagetrue
\vfil
\vfil
\eject
}}
%%}}}

\def\hinttagdecorator{H}
\def\solutiontagdecorator{S}
\def\fullprooftagdecorator{P}

\def\getpdef#1{\csgroup\csgroup\let{#1}={PDEF\paragid#1}}%

% needs \paragid to be set
\def\autogetpdefs{%
% this is needed to define \pdeflist in a mapover-able way
\ifcsname PDEFS\paragid\endcsname
\exploregroups\StrRemoveBraces{\csgroup{PDEFS\paragid}}[\pdeflist]%
\ea\Maps\ea\getpdef\ea{\pdeflist}%
\fi
}

%%{{{ \printproofsappendix 
\def\printproofsappendix{%
{%
\immediate\closeout\fullproofsfile
\innernewcount\curchapterno

\def\fullproofentry##1##2##3##4{%
% 1: chapno
% 2: paragid
% 3: paragtag (needed because of XXXnoproperreftext)
% 4: proof text
\ifnum##1>\curchapterno
\curchapterno=##1\relax
\goodbreak
\centerline{\fourteenbf\chapterName~##1}\fullproofskip
\fi
\begingroup
\def\paragid{##2}%
\def\paragtag{##3\fullprooftagdecorator}%
\noi
\llap{{\bf \reftagofid[##2]\fullprooftagdecorator.\enspace}}%
\labpageofid[##2_fullproof]%
% XXX: XXXnoproperreftext: reftext would make passing tag redundant:
% \labtagofid[##2_fullproof={\reftexttagofid{##2}}]
% instead of:
\labtagofid[##2_fullproof=\fullprooftagdecorator]%
\autogetpdefs
##4%
\endgroup
\goodbreak\fullproofskip
}

\safereadfile{proofs}
}%
}
%%}}}

%%{{{ \printhintsappendix 
\def\printhintsappendix{%
\immediate\closeout\hintsfile
{% begin group
\def\hintentry##1##2##3{%
% 1: paragid
% 2: hintno
% 3: hint body
\begingroup
\def\paragid{##1}%
\ifnum\number\i=##2\relax
\eop\noi
\llap{{\bf \reftagofid[##1]\hinttagdecorator##2.\enspace}}%
{\labtagofid[##1_hint_##2=##2]}%
\autogetpdefs
##3%
\goodbreak
\hintskip
\fi
\endgroup
\goodbreak
}%
% XXX: ^ hintentry was inside \Repeat
\Repeat \for{i} \from{1} \to{\maxhintno} \do {%
% hintsection sectionoid
\hintsection \hintsterm \#\number\i.
%%%% hintsection conf
% not exactly a conf but that's a good place
\hldestizepage
%%%% /hintsection conf

%%%% hintsection body
\safereadfile{hints}
\reallynobreak
%%%% /hintsection body

\endhintsection
% /hintsection
}% /Repeat
}% end group
}
%%}}}

%%{{{ \printsolutionsappendix 
\def\printsolutionsappendix{%
{%
\immediate\closeout\solutionsfile
\innernewcount\curchapterno

\def\solutionentry##1##2##3{%
% 1: paragid
% 2: chapterno
% 3: solution body
% print a header if we just started a new chapter's solutions
\ifnum##2>\curchapterno
    \curchapterno=##2\relax
    \goodbreak
    \centerline{\fourteenbf\sayName{chapter} \chapterthe{##2}}
    \nobreak\solutionskip
\fi
\noi
\begingroup
\def\paragid{##1}%
\llap{{\bf \reftagofid[##1]\solutiontagdecorator.\enspace}}%
\autogetpdefs
##3%
\endgroup
\solutionskip
}

\safereadfile{solutions}

}%
}
%%}}}

%%{{{ \printcodeappendix 
\def\printcodeappendix{%
{%
\safereadfile{programs}%
}%
}
%%}}}

%%}}}

%%{{{ backmatter printers

%%{{{ \printreferenceswith 
\def\printreferenceswith#1{%
\begingroup
\def\biblabelcontents##1{{\ninessdc[##1]}}%
\let\protect=\NIL
\def\newblock{\newline}
\def\UrlFont{\tenrm}
\sizex
\bibliographystyle{alpha}%
\bibliography{#1}%
\endgroup
}
%%}}}

%%{{{ \printsymbolglossary 
\def\printsymbolglossary{%
{%
\immediate\closeout\symbolsfile
\multiply\baselineskip by 2

\def\symbolentry##1##2##3##4{%
% 1: symbolid
% 2: symbol
% 3: pronunciation
% 4: pageno
\def\glossor{{\;;\;}}
\line{\llap{##2}\quad
      \hbox{##3}\quad
      \dotfill{}\enspace
      \reftagofid[##1],\enspace
      {##4}}%
}

\safereadfile{symbols}

}%
}
%%}}}

%%{{{ \printindexofnames 
\def\printindexofnames{%
\readindexfile n
}
%%}}}

%%{{{ \printindexofterms 
\def\printindexofterms{%
\readindexfile i
}
%%}}}

%%}}}

%%{{{ general-style 

% XXX: not implemented yet
\newdimen\vcur      % to hold current vpos
\newdimen\vminsec   % constant of minimum vspace required to start a section
\vminsec=42mm       % free space required to start section(oid)

%%{{{ page layout 

% top-level strings
%%%% A4:     210mm x 297mm
%%%% A5:     148mm x 210mm
%%%% letter: 8.5in x 11in

%\paperheight=297mm
%\paperwidth=210mm

\pdfpagewidth=8.5in
\pdfpageheight=11in
\paperheight=11in
\paperwidth=8.5in

% margins (THESE ARE NOT REGISTERS, see eplain)
\topmargin=28mm
\bottommargin=28mm
\leftmargin=34mm
\rightmargin=34mm

\normalbaselineskip=12pt \sizexi\rm

\everyfootnote={\baselineskip=11pt \sizeix\rm}

%%}}} 

%%{{{ draft / release versions
\ifdraft
\overfullrule=2cm
\else\overfullrule=0pt
\fi
%%}}}

%%}}}

%%{{{ \Report : XXX: remove? (better use a shell script for this) 

% \WriteReport counters
\newcount\chaptertotal      \chaptertotal=0\relax
\newcount\sectiontotal      \sectiontotal=0\relax
\newcount\chapblahtotal     \chapblahtotal=0\relax
\newcount\appendixtotal     \appendixtotal=0\relax
\newcount\paragtotal        \paragtotal=0\relax
\newcount\exercisetotal     \exercisetotal=0\relax
\newcount\problemtotal      \problemtotal=0\relax
\newcount\codeittotal       \codeittotal=0\relax

\def\makereport{%
\Report
\WriteReport {exercises} {\the\exercisetotal}%
\WriteReport {problems}  {\the\problemtotal}%
\WriteReport {chapters}  {\the\chaptertotal}%
\WriteReport {sections}  {\the\sectiontotal}%
\WriteReport {pages}     {\the\pageno}%
\EndReport
}

\newwrite\reportfile
\def\Report{\immediate\openout\reportfile=\jobname.report}
\def\WriteReport#1#2{\write\reportfile{#1:#2}}
\def\EndReport{\closeout\reportfile}

%%}}}

%%{{{ refs, tags, labels, etc.

\newif\ifsectionwidetags \sectionwidetagsfalse
\def\sectionwidetags{\sectionwidetagstrue}
\def\paragwidetags{\sectionwidetagsfalse}

% Use \sectionwidetags right after \section to keep count within the section.
% Normally the count is reset on every \note-like.

\def\ideqconstruct#1{#1}
\def\sectionwidetag#1{\ifnil\sectag\\#1\else\sectag\,{#1}\fi}
\def\paragwidetag#1{\ifnil\paragtag\\#1\else\paragtag\,{#1}\fi}
\def\neartag#1{#1}
\def\fartag#1{\ifsectionwidetags\sectionwidetag{#1}\else\paragwidetag{#1}\fi}
\def\fareqconstruct#1{\fartag{#1}}
\let\eqconstruct=\fareqconstruct

%%}}}

%%{{{ indexing 

%%{{{ setup 

%\defineindex i % this is already defined by eplain
\defineindex n % friends
\def\idxnormalpage#1{{\rm #1}}
\def\idxdefpage#1{{\bf #1}}
\indexproofingfalse % default is false anyway
\hookaction{beginindex}{\doublecolumns}
\def\indexfonts{\sizex}
\def\seevariant{\color{slightlyfaded}\it}

% symbol counter
\newcount\symbolidno

\def\sholed#1{{\alert{#1}}}

%%}}}

%%{{{ interface based on eplain 
\def\INDEX#1{\sidx[pagemarkup=idxnormalpage]{#1}}
\def\INDEXDEF#1{\sidx[pagemarkup=idxdefpage]{#1}}
\def\INDEXSEE#1#2{\sidx[see]{#1}{#2}}
\def\INDEXSEEALSO#1#2{\sidx[seealso]{#1}{#2}}
\def\INDEXNAME#1#2{\sndxname[pagemarkup=idxnormalpage]{#1}{#2}}
% (no more eplain should be used from now on)
%%}}}

%%{{{ low-level: the user should not need any of these 
\def\INDEXES * #1 ;; {{\Map{ * }\SMARTINDEX{#1}}}
\def\CREDITS * #1 ;; {{\Map{ * }\SMARTCREDIT{#1}}}
\def\DEFINES * #1 ;; {{\Map{ * }\INDEXDEForINDEXSYMBOLPRIME{#1}}}

\def\SMARTINDEX#1{%
    \IfStrContains {#1} { see: }
        {\INDEXSEEPRIME #1;}
        {\IfStrContains {#1} { seealso: }
            {\INDEXSEEALSOPRIME #1;}
            {\INDEX{#1}}}}
\def\INDEXSEEPRIME #1 see: #2;{\INDEXSEE{#1}{#2}}
\def\INDEXSEEALSOPRIME #1 seealso: #2;{\INDEXSEEALSO{#1}{#2}}

\def\SMARTCREDIT#1{%
    \IfStrContains {#1} { : }
        {\CREDITFORPRIME #1;}
        {\CREDIT{#1}}}
\def\CREDITFORPRIME #1 : #2;{\csgroup{#1}[#2]}
\def\CREDIT#1{\csgroup{#1}}

\def\INDEXSYMBOLPRIME#1{\INDEXSYMBOLPRIMEPRIME #1\END}
\def\INDEXSYMBOLPRIMEPRIME #1-- #2\END{\INDEXSYMBOL{#1 }{#2}}
\def\INDEXDEForINDEXSYMBOLPRIME#1{\saveexpandmode\noexpandarg\IfStrContains{#1}{--}{\INDEXSYMBOLPRIME{#1}}{\INDEXDEF{#1}}\restoreexpandmode}
\def\INDEXSYMBOL#1#2{%
% 1: symbol
% 2: pronunciation
\global\advance\symbolidno by 1\relax
\labtagofid[symbol\number\symbolidno=\paragtag]%
\labpageofid[symbol\number\symbolidno]%
\writesymbol
  {symbol\number\symbolidno}
  {\unexpanded{\let~=\sholed $#1$}}
  {\unexpanded{#2}}
  {\number\pageno}%4
}
%%}}}

%%{{{ user interface 

% generic index commands
\def\indexed[#1]{\SMARTINDEX{#1}}% for inline use
\def\credited[#1]{\SMARTCREDIT{#1}}% for inline use
\def\defined[#1]{\INDEXDEForINDEXSYMBOLPRIME{#1}}% for inline use

% these should probably be placed on a separate file
\def\DefFriend #1 #2, #3; {%
\csgroup\def{#1}{\INDEXNAME{#3}{#2}}% this has an optional arg
\csgroup\def{say#1}{{\csname #1\endcsname}#2}%
\csgroup\def{full#1}{{\csname #1\endcsname}#3 #2}%
}

%%}}}

%%}}}

%%{{{ spoilers 

\Newskip spoiler=4\bigskipamount;

\def\spoiler{% TODO
\spoilerglue
\nobreak\centerline{{\color{spoiler}\hrulefill\qquad\bf!!~~SPOILER ALERT~~!!\qquad\hrulefill}}%
\spoilerskip
\goodbreak
}

\def\spoilerpage{% TODO
\nobreak\vfill
\nobreak\centerline{{\color{spoiler}\hrulefill\qquad\bf!!~~SPOILER ALERT~~!!\qquad\hrulefill}}%
\nobreak\vfill
\break
}

%%}}}

%%{{{ struct setup and sidekicks 

% by default all structs are labelled as toplevel dirs
\newif\iftoplevelstruct     \toplevelstructtrue

%%{{{ counters 

% base id counters
\newcount\chapidno
\newcount\secidno
\newcount\paragidno

% text struct counter
\newcount\chapterno
\newcount\appendixno
\newcount\sectionno

% parag counters
\newcount\paragno

% activity struct counters
\newcount\exerciseno
\newcount\codeitno
\newcount\problemno
\newcount\hintno
\newcount\maxhintno
\newcount\hintstatusno

%%}}}

%%{{{ *nest systems 
% chapnest helps guarantee matching \chap...\endchap macros
% Note that there still is a need for a "secnest system"  because
% even though the definitions of sec* guarantee well-balanced macros,
% we may put a sec inside a different type of sec,
% e.g. \section .. \further .. \endfurther .. \endsection
\newcount\chapnest  \chapnest=0\relax
\newcount\secnest   \secnest=0\relax
\newcount\paragnest \paragnest=0\relax
\def\chapenter{%
\ifnum\secnest   > 0\thatexerror[tried to open chap inside sec (\secid)]\fi
\ifnum\paragnest > 0\thatexerror[tried to open chap inside parag (\paragid)]\fi
\ifnum\chapnest  > 0\thatexerror[tried to open chap inside another (\chapid)]\fi
\global\advance\chapnest  by  1\relax
}
\def\chapleave{%
\ifnum\secnest   > 0\thatexerror[tried to close chap inside a sec (\secid)]\fi
\ifnum\paragnest > 0\thatexerror[tried to close chap inside a parag (\paragid)]\fi
\ifnum\chapnest  < 1\thatexerror[closed a chap but wasn't inside one?]\fi
\global\advance\chapnest  by -1\relax
}
\def\secenter{%
\ifnum\paragnest > 0\thatexerror[tried to open sec inside a parag (\paragid)]\fi
\ifnum\secnest   > 0\thatexerror[tried to open sec inside another (\secid)]\fi
\global\advance\secnest   by  1\relax
}
\def\secleave{%
\ifnum\paragnest > 0\thatexerror[tried to close sec (\secid) inside a parag (\paragid)]\fi
\ifnum\secnest   < 1\thatexerror[closed a sec (\secid) but wasn't inside one?]\fi
\global\advance\secnest   by -1\relax
}
\def\paragenter{%
\ifnum\paragnest > 0\thatexerror[opened a parag (\paragclass) inside a parag? (\paragid)]\fi
\global\advance\paragnest by  1\relax
}
\def\paragleave{%
\ifnum\paragnest < 1\thatexerror[closed a parag (\paragclass) but wasn't inside one?]\fi
\global\advance\paragnest by -1\relax
}
%%}}}

%%{{{ struct mixin 

% \struct* stuff are practically locally set just
% for the purpose of setting the labels with \dostructlabels
% TODO: reorganize for the final results to get more usefl (the actual labels set)

%%{{{ \structpreconfmixin 
% \structpreconfmixin #1 sets struct attributes to \#1attr
% CLASSclass should be set before calling structpreconfmixin
\def\structpreconfmixin#1{%
\edef\structbase{#1}%
% clear/set default values
\def\structid{}%
\def\structclass{}% <- this must be provided by the context of the caller
\def\structtag{}%   <- this may be provided by the context of the caller
\def\structformal{\sayName{\structclass} \structtag}% <- probably bad idea to overwrite
\def\structclassname{}%
\def\structtitle{}%
\def\structaka{}%
\def\structlabel{}%
\def\structfull{\structformal\ifvanishes\structtitle\\\else\spacechar(\structtitle)\fi}%
\def\structsmart{\structclassname \structtag\ifvanishes\structaka\\\else\spacechar(\structaka)\fi}%
% XXX: most of these will be re-mixedin later by structpostconfmixin
\Mixin
    class classname tag
    id title aka
    full smart formal
    \from {\structbase}
    \to struct
% class should be set before calling structpreconfmixin:
\ifvanishes\structclass\\\thatexerror[class must be set before you structpreconfmixin]\fi
}
%%}}}

%%{{{ \structpostconfmixin 
% call this after doing the conf
\def\structpostconfmixin#1{%
\edef\structbase{#1}%
\Mixin
    classname tag
    title aka
    full smart formal
    \from {\structbase}
    \to struct
}
%%}}}

%%{{{ \dostructlabels 
\def\dostructlabels{{%
\WhenStrEmpty {\structclass}
    {\thatexerror[dostructlabels called but there is no structclass]}%
% basic labels set even for structlabel-less structs:
\setlabelclass{\structclass}%
\labpageofid[\structid]%
\WhenStrNempty {\structtag}
    {\labtagofid[\structid=\structtag]}%
% these labels need structlabel to be set
%%%% if we have \structlabel
\WhenStrNempty {\structlabel} {%
% low <-> high is actually an injection high >-> low:
\labidof[\structlabel=\structid]%
\lablabelofid[\structid=\structlabel]%
% usual labels:
\labpage[\structlabel]%
\labtitle[\structlabel=\structtitle]%
\labtag[\structlabel=\structtag]%
\labformal[\structlabel=\structformal]%
\labsmart[\structlabel=\structsmart]%
\labfull[\structlabel=\structfull]%
\lab[\structlabel=\structtag]% <- maybe this is never used?
}%%%% /if we have \structlabel
}}
%%}}}

%%}}}

%%{{{ struct/label/ref/cd shortcuts 

\def\label #1 {%
\def\structlabel{#1}%
\iftoplevelstruct\def\structpath{/#1/}\else\edef\structpath{\structpath#1/}\fi
}

\def\labcdhere{\labCD{\structpath}}
\def\refcdhere{\refCD{\structpath}}
\def\labrefcdhere{\labrefCD{\structpath}}
\let\cdhere=\labrefcdhere

%%}}}

%%}}}

%%{{{ chap 
% TODO: this should be made similar to the sec/parag mechanism
% TODO: chapblahs should be implemented accordingly as
%       special cases of chaps without chapno

%%{{{ chap(teroids) 

\Newskip chaptitle=12ex;
\Newskip chapblahtitle=.5\chaptitleskipamount;

\definecolor{introcolor}{cmyk}{.5,.5,.5,1}
\definecolor{wherecolor}{cmyk}{0.5,.1,.3,.4}
\definecolor{wheretoccolor}{cmyk}{0.5,.1,.3,.4}
\definecolor{quotecolor}{cmyk}{0.5,.1,.3,.4}

\DefStyle intro         {\color{introcolor}\tenrm}
\DefStyle chapwhere     {\color{wherecolor}\tenit}
\DefStyle chapquote     {\ninesl}
\DefStyle chapquoteby   {\elevenrm\scshape}

\def\chapintro#1\par{\noindent\introstylize{#1}\endgraf\chaptitleskip}

\def\chapclassname{\sayName{\chapclass}}

%%{{{ \dochapconf 
\def\dochapconf#1{%
% 1: conf body
\def\dochapindexes{}%
\def\dochapcredits{}%
\def\dochappdefs{}%
\def\chapquote{}%
\def\chapquoteby{}%
\def\chapwhere{}%
% save current macros
\let\OLDquote=\quote
\let\OLDwhere=\where
\let\OLDindexes=\indexes
\let\OLDcredits=\credits
\let\OLDpdefs=\pdefs
% set conf-special macros
\def\where ##1 ;; {\def\chapwhere{##1}}%
\def\quote ##1 \by ##2 ;; {\def\chapquote{##1}\def\chapquoteby{##2}}%
\def\indexes * ##1 ;; {\def\dochapindexes{\INDEXES * ##1 ;; }}%
\def\credits * ##1 ;; {\def\dochapcredits{\CREDITS * ##1 ;; }}%
\def\pdefs ##1 ;; {%
% XXX: code dup with other pdefs
\def\dochappdefs{%
\def\pdef########1 {%
\unskip
% the cs PDEFS\chapid holds a space-separated list of all pdef names
% this get inherited as a predefined PDEFS\secid for each sec
\ifcsname PDEFS\chapid\endcsname
    \csgroup\gaddto{PDEFS\chapid}{ }\else
    \csgroup\gdef{PDEFS\chapid}{}\fi
\csgroup\gaddto{PDEFS\chapid}{########1}%
\csgroup\def{########1}{\csgroup{PDEF\chapid ########1}}%
\csgroup\gdef{PDEF\chapid ########1}%
}% /pdef
##1%
}% /dochappdefs
}% /pdefs
% actually do the conf
#1%
% restore macros
\let\quote=\OLDquote
\let\where=\OLDwhere
\let\indexes=\OLDindexes
\let\credits=\OLDcredits
\let\pdefs=\OLDpdefs
}
%%}}}

%%{{{ \resetchapwidecounters 
\def\resetchapwidecounters{%
\paragno=0\relax
\exerciseno=0\relax
\codeitno=0\relax
\problemno=0\relax
}
%%}}}

%%{{{ \genbeginchap 
\def\genbeginchap#1#2#3{%
% 1: chap class
% 2: chap title
% 3: chap conf
\chapenter
\begingroup % chap total namespace
\def\chapconf   {#3}%
\edef\chapclass {#1}%
% XXX: decide: \edef or \def for title?
\def\chaptitle {#2}%
%%%% counters and toks
\global\advance\chapidno  by 1\relax
\csgroup\let\chapthe   = {\chapclass the}\relax
\csgroup\let\chapno    = {\chapclass no}\relax
\csgroup\let\chaptotal = {\chapclass total}\relax
\global\advance\chapno    by 1\relax
\global\advance\chaptotal by 1\relax
%%%% chap getter (gets chapter##1, appendix##1, etc.)
\def\getchapclass##1{\csname\chapclass ##1\endcsname}%
%%%% tag and id are needed to call structpreconfmixin
\edef\chaptag     {\chapthe{\number\chapno}}%
\edef\chapid      {chap\number\chapidno}%
%%%% we have: class, title, tag, id.
\structpreconfmixin{chap}%
%%%% page decorations
\titlepagetrue
\global\topmarker={\sayName{\chapclass} \chaptag:  \chaptitle}%
\global\toptitle={\the\topmarker}%
%%%% counters
\resetchapwidecounters
%%%% chap main namespace
\bgroup % will end in \endchap*
%%%% conf
\dochapconf{\chapconf}%
%%%% structlabels
\structpostconfmixin{chap}%
\WhenStrNempty {\structid}
    {\dostructlabels}%
%%%% toc stuff
\hldestizepage
\WRITENUMBEREDTOCENTRY
    {\chapclass}
    {\chaptitle}
    {\number\chapno}%
\titlepagetrue
%%%% start outputting
%% chap bandana
\dochapquote
%% /chap bandana
%% chap head
\vglue 2ex\relax
\centering
\twelverm
\sayNAME{\chapclass} \chaptag%
\vglue 4ex\relax
\chaptitle
% for upper use: \ea\ea\ea\toupper\ea{\chaptitle}
\endcentering
%% /chap head
%% chap necklace
\dochapwhere
%% /chap necklace
\chaptitleskip
%%%% tasks
\dochapindexes
\dochapcredits
\dochappdefs
\noindent
}
%%}}}

%%{{{ \genendchap 
\def\genendchap{%
% could take #1 for chap class but there is no use for it now
\egroup % /chap main namespace
\ifdim\pagetotal=0pt\relax\else\vfill$$\woohoo$$\eject\fi
\endgroup % /chap total namespace
\chapleave
}
%%}}}

%%{{{ \dochapwhere 
\def\dochapwhere{%
\WhenStrNempty {\chapwhere}
{%
\vglue 6ex\relax
\WRITETOCENTRY
    {where}
    {\chapwhere}%
\centeringmargin 42pt
\chapwherestylize{\chapwhere}
\endcenteringmargin
\vglue 6ex\relax
}%
}
%%}}}

%%{{{ \dochapquote 
\def\dochapquote{%
\WhenStrNempty {\chapquote}
{%
\bgroup \color{quotecolor}%
\rightingmargin {.333\hsize}
\chapquotestylize{\chapquote}%
\endrightingmargin
\righting
\chapquotebystylize{---~\chapquoteby}%
\endrighting
\egroup
\vglue 4ex\relax
}%
}
%%}}}

%%{{{ instances: chapter, appendix 

\def\DefChap #1 {\csgroup\def{#1}##1. ##2\par{\genbeginchap {#1} {##1}{##2}}\csgroup\def{end#1}{\genendchap}}

\def\chapterthe#1{\nthe{#1}}
\def\appendixthe#1{\Athe{\number#1}}

% XXX: the defs above should become:
%\SetChap chapter  the #1{\nthe{#1}}
%\SetChap appendix the #1{\Athe{\number#1}}

\DefChap chapter
\DefChap appendix

%%}}}

%%}}}

%%{{{ chapblah 

\def\chapblahtitlestylize#1{\vglue 4ex\centerline{\fourteenbf\vphantom{ÂÇ}#1}\par\vskip.5ex\hrule}

%%{{{ \dochapblahconf 
\def\dochapblahconf#1{%
\def\chapquote{}%
\def\chapquoteby{}%
\def\chapwhere{}%
% save current macros
\let\OLDquote=\quote
\let\OLDwhere=\where
% set conf-special macros
\def\where ##1 ;; {\def\chapwhere{##1}}%
\def\quote ##1 \by ##2 ;; {\def\chapquote{##1}\def\chapquoteby{##2}}%
% actually do the conf
#1%
% restore macros
\let\quote=\OLDquote
\let\where=\OLDwhere
}
%%}}}

%%{{{ \chapblah 
\def\chapblah #1. #2\par{%
% 1: chapblah title
% 2: chapblah conf
\chapenter
\begingroup % chapblah total namespace
\def\chapblahconf{#2}%
\edef\chapblahtitle{#1}%
%%%% page decorations
\titlepagetrue
\oddpage
\global\topmarker={\chapblahtitle}%
\global\toptitle={\the\topmarker}%
%%%% counters
\resetchapwidecounters
%%%% chap main namespace
\bgroup % will end in \endchap*
%%%% conf
\dochapblahconf{\chapblahconf}%
%%%% toc stuff
\hldestizepage
\WRITETOCENTRY
    {chapblah}
    {\chapblahtitle}%
\titlepagetrue
%%%% start outputting
%% chap bandana
\dochapquote
%% /chap bandana
%% chapblah head
\chapblahtitlestylize{\expanded{\chapblahtitle}}
%% /chapblah head
%% chapblah necklace
\dochapwhere
%% /chapblah necklace
\chapblahtitleskip
\noindent
}
%%}}}

%%{{{ \endchapblah 
\def\endchapblah{%
\egroup % /chapblah main namespace
\vfill$$\woohoo$$%
\makenextpageodd
\eject
\endgroup % /chapblah total namespace
\chapleave
}
%%}}}

%%}}}

%%}}}

%%{{{ sec 
% the situation is reversed from chap*:
% in sec* we have only one main tagged instance (\section)
% and many blahs

%%{{{ default attrs and common macros 

\def\secintro#1\par{\medskip\noindent{#1}\endgraf\sectitleskip}

\Newskip sectitle=.333\chaptitleskipamount;
\Newskip sec=2\bigskipamount;

\def\secno{}
\def\sectotal{}
\def\secthe#1{\nthe{#1}}
\def\sectag{}
\def\sectagdecorator{§}
\def\secdecoratetag#1{\sectagdecorator#1}
\def\sectitle{}
\def\secahook{}
\def\seczhook{}
\def\secheadahook{\par\noindent\hfil\begingroup\twelvebf}
\def\sechead{\WhenStrNempty{\sectag}{\sectag. }\WhenStrNempty{\sectitle}{\sectitle}}
\def\secheadzhook{\endgroup\hfil\endgraf\sectitleskip}
\def\secbodyahook{\noindent}
\def\secbodyzhook{}
\def\secclassname{\sayName{\secclass}}

%%{{{ \dosecconf 
% common configuration macros for note
\def\dosecconf#1{%
\def\dosecindexes{}%
\def\dosecdefines{}%
\def\doseccredits{}%
\def\dosecpdefs{}%
% save current macros
\let\OLDindexes=\indexes
\let\OLDdefines=\defines
\let\OLDcredits=\credits
\let\OLDpdefs=\pdefs
% set conf-special macros
\def\indexes * ##1 ;; {\def\dosecindexes{\INDEXES * ##1 ;; }}%
\def\defines * ##1 ;; {\def\dosecdefines{\DEFINES * ##1 ;; }}%
\def\credits * ##1 ;; {\def\doseccredits{\CREDITS * ##1 ;; }}%
\def\pdefs ##1 ;; {%
% XXX: code dup with other pdefs
\def\dosecpdefs{%
\def\pdef########1 {%
\unskip
% the cs PDEFS\secid holds a space-separated list of all pdef names
% this get inherited as a predefined PDEFS\pragid for each parag
\ifcsname PDEFS\secid\endcsname
    \csgroup\gaddto{PDEFS\secid}{ }\else
    \csgroup\gdef{PDEFS\secid}{}\fi
\csgroup\gaddto{PDEFS\secid}{########1}%
\csgroup\def{########1}{\csgroup{PDEF\secid ########1}}%
\csgroup\gdef{PDEF\secid ########1}%
}% /pdef
##1%
}% /dosecpdefs
}% /pdefs
% actually do the conf
#1%
% restore macros
\let\indexes=\OLDindexes
\let\defines=\OLDdefines
\let\credits=\OLDcredits
\let\pdefs=\OLDpdefs
}
%%}}}

%%{{{ \resetsecwidecounters 
\def\resetsecwidecounters{%
\resetmcount
}
%%}}}

%%}}}

%%{{{ \genbeginsec 
\def\genbeginsec#1#2#3{%
% NOTE: Some work has been done to make it easy to
% get a \genbeginsec out of it, but not completely:
% some section-specific parts remain.
% 1: sec class
% 2: sec title
% 3: sec conf
\begingroup % section total namespace (will end in \endsec)
\edef\secclass  {#1}%
\edef\sectitle  {#2}% XXX: decide \def or \edef
\def\secconf    {#3}%
\secenter
%% mixin attrs
\Mixin
    no total
    skip
    the
    tag decoratetag tagdecorator
    ahook zhook
    head headahook headzhook
    body bodyahook bodyzhook
    \from {SEC\secclass}
    \to sec
%%%% counters and toks
\global\advance\secidno by 1\relax
\ifblank\secno   \else\global\advance\secno    by 1\relax\fi
\ifblank\sectotal\else\global\advance\sectotal by 1\relax\fi
%%%% id is needed to call structpreconfmixin
\edef\secid      {sec\number\secidno}%
\ifblank\secno\else\edef\sectag{\secdecoratetag{\secthe{\number\secno}}}\fi
%%%% title for secblah and other notaggeds
\ifblank\secno\WhenStrEmpty {\sectitle}
    {\edef\sectitle{\csgroup{\secclass term}}}\fi
%%%% structpreconfmixin
\structpreconfmixin{sec}%
%%%% page decorations
\def\toptitlewithsec{\sechead}%
\global\toptitle=\ea{\toptitlewithsec}%
%%%% counters
\resetsecwidecounters
%%%% section main namespace
\begingroup % will end in \endsec
%%%% conf
\dosecconf{\secconf}%
% inherit pdefs from PDEFS\chapid
\ifcsname PDEFS\chapid\endcsname
    \csgroup\ea\gdef\ea{PDEFS\secid}\ea{\csname PDEFS\chapid\endcsname}\fi
%%%% structlabels
\structpostconfmixin{sec}%
\WhenStrNempty {\structid}
    {\dostructlabels}%
%%%% start outputting
\goodbreak
\secahook
% sechead
\secheadahook
\sechead
\secheadzhook
% /sechead
\nobreak
%%%% toc stuff
\hldestizepage
\ifblank\secno\WRITETOCENTRY
                  {secblah}
                  {\sectitle}%
\else         \WRITENUMBEREDTOCENTRY
                  {\secclass}
                  {\sectitle}
                  {\number\secno}\fi
%%%% tasks
\dosecindexes
\dosecdefines
\doseccredits
\dosecpdefs
%%%% main body
\secbodyahook
}
%%}}}

%%{{{ \genendsec 
\def\genendsec{%
% could take #1 for sec class but there is no use for it now
\secbodyzhook
\endgroup % /sec* main namespace
\seczhook % maybe evolve into yhook/zhook (for the time being not used)
\secskip
\secleave
\endgroup % /sec* total namespace
\goodbreak
}

%%}}}

%%{{{ \DefSec \SetSec \DoSec 

% defines both \secinst and \endsecinst
\def\DefSec #1 {\csgroup\def{#1}##1. ##2\par{\genbeginsec {#1} {##1}{##2}}\csgroup\def{end#1}{\genendsec}}

\def\SetSec #1 #2 #3#{\csgroup\def{SEC#1#2}#3}
% 1: class of sec; 2: attr; 3: args string (e.g. #1#2{...} for binary methods)
% (see SetParag for an example)

\def\DoSec #1 #2 {\csgroup{SEC#1#2}}
% 1: class of sec; 2: attr

%%}}}

%%{{{ sec instances 

%% tagged instances

\SetSec section no    {\sectionno}
\SetSec section total {\sectiontotal}
\DefSec section

%% untagged instances

\DefSec secblah
\DefSec problems
\DefSec further
\DefSec history
\DefSec summary
\DefSec hintsection

%%}}}

%%}}}

%%{{{ parag 

%%{{{ \doparagconf 
\def\doparagconf#1{%
% 1: conf body
\def\doparagindexes{}%
\def\doparagdefines{}%
\def\doparagcredits{}%
\def\doparagpdefs{}%
% save current macros
\let\OLDaka=\aka
\let\OLDindexes=\indexes
\let\OLDdefines=\defines
\let\OLDcredits=\credits
\let\OLDpdefs=\pdefs
\let\OLDrelates=\relates
\let\OLDof=\of
\let\OLDthis=\this
% set conf-special macros
% \this-interface (to be used rarely, if ever)
\def\this ##1 ##2 {\csgroup\def{parag##1}{##2}}%
\def\aka ##1. {\def\paragaka{##1}}%
\def\relates ##1 {\def\paragrelates{##1}}%
\let\of=\relates
\def\headerize {\edef\paragclassname{\paragtitle}\def\paragtitle{}}%
\def\indexes * ##1 ;; {\def\doparagindexes{\INDEXES * ##1 ;; }}%
\def\defines * ##1 ;; {\def\doparagdefines{\DEFINES * ##1 ;; }}%
\def\credits * ##1 ;; {\def\doparagcredits{\CREDITS * ##1 ;; }}%
\def\pdefs ##1 ;; {%
% XXX: code dup with other pdefs
\def\doparagpdefs{%
\def\pdef########1 {%
\unskip
% the cs PDEFS\paragid holds a space-separated list of all pdef names
% this is mapped over later on in \fullproofentry
\ifcsname PDEFS\paragid\endcsname
    \csgroup\gaddto{PDEFS\paragid}{ }\else
    \csgroup\gdef{PDEFS\paragid}{}\fi
\csgroup\gaddto{PDEFS\paragid}{########1}%
\csgroup\def{########1}{\csgroup{PDEF\paragid ########1}}%
\csgroup\gdef{PDEF\paragid ########1}%
}% /pdef
##1%
}% /doparagpdefs
}% /pdefs
% actually do the conf
\paragaconf
#1%
\paragzconf
% restore macros
\let\aka=\OLDaka
\let\indexes=\OLDindexes
\let\defines=\OLDdefines
\let\credits=\OLDcredits
\let\pdefs=\OLDpdefs
\let\relates=\OLDrelates
\let\of=\OLDof
\let\this=\OLDthis
}
%%}}}

%%{{{ \resetparagwidecounters 
\def\resetparagwidecounters{%
\ifsectionwidetags\reseteqnumber
\else             \resetmcount
\fi
}
%%}}}

%%{{{ parag constructor/prototype 

%%{{{ default attrs 

\Newskip parag=.5\bigskipamount;
\def\paragthe#1{\nthe{#1}}
\def\paragnocounter{\paragno}
\def\paragtotalcounter{\paragtotal}
\def\paragaconf{}
\def\paragzconf{}
\def\paragtag{}
\def\paragtagahook{}
\def\paragtagbhook{}
\def\paragtagyhook{.}
\def\paragtagzhook{}
\def\paragtagdecorator{}
\def\paragdecoratetag#1{\paragtagdecorator#1}
\def\paragtitle{}
\def\paragaka{}
\def\paragclassname{\sayName{\paragclass}}
\def\paragasymbol{}
\def\paragasymbolahook{\ifx\NIL\paragrelates\thinspace\fi}
\def\paragasymbolzhook{\enspace}
\def\paragshowasymbol{\ifx\NIL\paragasymbol\else\paragasymbolahook\paragasymbol\paragasymbolzhook\fi}
\def\paragzsymbol{}
\def\paragzsymbolahook{\unskip\nobreak\hfill}
\def\paragzsymbolzhook{}
\def\paragshowzsymbol{\ifx\NIL\paragzsymbol\else\paragzsymbolahook\paragzsymbol\paragzsymbolzhook\fi}
\def\paragrelates{}
\def\paragrelatessymbol{\relatessymbol}
\def\paragahang{\ifx\NIL\paragrelates\else(\reftag[\paragrelates])\enspace\paragrelatessymbol\fi}
\def\paragahangahook{}
\def\paragahangbhook{\sizeix\rm}
\def\paragahangyhook{}
\def\paragahangzhook{\enspace}
\def\paragzhang{}
\def\paragzhangahook{}
\def\paragzhangbhook{}
\def\paragzhangyhook{}
\def\paragzhangzhook{}
\def\paragshowahang{\ifx\NIL\paragahang\else\paragahangahook\begingroup\paragahangbhook\paragahang\paragahangyhook\endgroup\paragahangzhook\fi}
\def\paragshowzhang{\ifx\NIL\paragzhang\else\rlap{\paragzhangahook\begingroup\paragzhangbhook\paragzhang\paragzhangyhook\endgroup\paragzhangzhook}\fi}
\def\paragahook{\noindent\llap{\paragshowahang\paragshowasymbol}}
\def\paragzhook{\paragshowzsymbol\paragshowzhang}
\def\paragshowtag{\paragtagahook\begingroup\paragtagbhook\paragtag\paragtagyhook\endgroup\paragtagzhook}
\def\paraghead{\paragshowtag \paragclassname\WhenStrNempty{\paragtitle}{ (\paragtitle)}\WhenStrNempty{\paragaka}{ (\paragaka)}}
\def\paragheadahook{\noindent}
\def\paragheadbhook{\bf}
\def\paragheadyhook{.}
\def\paragheadzhook{\enspace}
\def\paragbodyahook{}
\def\paragbodybhook{}
\def\paragbody{}
\def\paragbodyextras{}
\def\paragbodymacros{}
\def\paragbodyyhook{}
\def\paragbodyzhook{}
\def\paragfeetahook{}
\def\paragfeet{}
\def\paragfeetzhook{}

%%}}}

%%{{{ \genparag 
\long\def\genparag#1#2#3#4#5{%
% 1: parag class
% 2: parag title
% 3: parag conf
% 4: parag body
% 5: parag extras <- might contain \par's
\begingroup % parag total namespace
\edef\paragclass     {#1}%
\edef\paragtitle     {#2}%
\def\paragconf       {#3}%
\paragenter
\def\paragbody       {#4}%
\def\paragbodyextras {#5}%
%% mixin attrs
\Mixin
    nocounter totalcounter
    skip
    the
    aconf zconf
    tag tagahook tagbhook tagyhook tagzhook showtag
    decoratetag tagdecorator
    asymbol asymbolahook asymbolzhook showasymbol
    zsymbol zsymbolahook zsymbolzhook showzsymbol
    relates relatessymbol
    ahang ahangahook ahangbhook ahangyhook ahangzhook showahang
    zhang zhangahook zhangbhook zhangyhook zhangzhook showzhang
    ahook zhook
    head headahook headbhook headyhook headzhook
    body bodyahook bodybhook bodymacros bodyyhook bodyzhook
    feet feetahook feetzhook
    \from {PARAG\paragclass}
    \to parag
%%%% counters and toks
\global\advance\paragidno    by 1\relax
\edef\paragid        {parag\number\paragidno}%
\ifblank\paragnocounter   \else\global\advance\paragnocounter    by 1\relax\fi
\ifblank\paragtotalcounter\else\global\advance\paragtotalcounter by 1\relax\fi
% set default paragtag for counted parags
\ifblank\paragnocounter
  \else \WhenStrEmpty {\paragtag}
     {\def\paragtag{\paragdecoratetag{\chaptag.\paragthe{\paragnocounter}}}}\fi
%%%% structpreconfmixin (id and class needed)
\structpreconfmixin{parag}%
%%%% counters
\resetparagwidecounters
%%%% parag main namespace
\begingroup
%%%% conf
\doparagconf{\paragconf}%
%%%% counters
% inherit pdefs from PDEFS\secid
\ifcsname secid\endcsname\ifcsname PDEFS\secid\endcsname
    \csgroup\ea\gdef\ea{PDEFS\paragid}\ea{\csname PDEFS\secid\endcsname}\fi\fi
%%%% structlabels
\structpostconfmixin{parag}%
\WhenStrNempty {\structid}
    {\dostructlabels}%
%%%% start outputting
\eop
\noi
\paragahook
% paraghead
\paragheadahook
\begingroup
\paragheadbhook
\paraghead
\paragheadyhook
\endgroup
\paragheadzhook
% /paraghead
%%%% toc stuff
%%%% tasks
\doparagindexes
\doparagdefines
\doparagcredits
\doparagpdefs
%%%% main body
\paragbodyahook
\begingroup
\paragbodymacros
\paragbodybhook
\paragbody
\unskip
\paragbodyextras
\paragbodyyhook
\endgroup
\paragbodyzhook
\paragfeetahook
\paragfeet
\paragfeetzhook
\paragzhook
\endgroup % /parag main namespace
\par
\paragskip
\endgroup % /parag total namespace
\paragleave
% XXX: is this still useful?
\hphantom{...}%
\goodbreak
}
%%}}}

%%{{{ metaprogramming interface 

% XXX: why does the (old) ##3\par\par delimited version work
% without \long when ##3 contains \par's?

% For atomic parags that do not admit paragextras
\def\DefAParag #1 {%
\csgroup\def{#1}##1. ##2\par##3\par\par{\genparag {#1} {##1}{##2}{##3}{}}%
}

% For molecular parags that may have paragextras
\def\DefMParag #1 {%
\csgroup\long\def{#1}##1. ##2\par##3\par\par{%
\MOLPARAGSPLITTER {#1}{##1}{##2} ##3\par\ENDMOLPARAGSPLITTER
}%
}
\long\def\MOLPARAGSPLITTER #1#2#3 #4\par#5\ENDMOLPARAGSPLITTER{\genparag {#1}{#2}{#3}{#4\unskip}{#5}}

% Flex versions define two versions of parag macros:
% \foo .. \endfoo  and  \Foo ..
\def\DefFlexAParag #1#2 {%
\uppercase{\def\FirstLetter{#1}}%
\csgroup\csgroup\def{#1#2}##1. ##2\par##3\par{end#1#2}\par{\genparag {#1#2} {##1}{##2}{##3}{}}%
\csgroup\def{\FirstLetter #2}##1. ##2\par##3\par\par{\genparag {#1#2} {##1}{##2}{##3}{}}%
}

\def\DefFlexMParag #1#2 {%
\uppercase{\def\FirstLetter{#1}}%
\csgroup\csgroup\long\def{#1#2}##1. ##2\par##3\par##4{end#1#2}\par{\genparag {#1#2} {##1}{##2}{##3}{##4}}%
\csgroup\def{\FirstLetter #2}##1. ##2\par##3\par{\genparag {#1#2} {##1}{##2}{##3}{}}%
}

\def\SetParag #1 #2 #3#{\csgroup\def{PARAG#1#2}#3}
% 1: class of parag; 2: attr; 3: args string (e.g. #1#2{...} for binary methods)
% e.g.: \SetParag question decoratetag #1{--\paragtagdecorator#1?--}

\def\DoParag #1 #2 {\csgroup{PARAG#1#2}}
% 1: class of parag; 2: attr

% \DefAtomParagMac is used to define a general-functionality macro for parags
% \LetParagMac is used to \let an already defined parag macro to the scope of this parag
% some ####-hell is avoided this way
\def\DefAtomParagMac #1 {\csgroup\def{PARAGMACRO#1}}
\def\LetParagMac #1 = #2 {\csgroup\csgroup\let{#1}={PARAGMACRO#2}}

%%}}}

%%}}}

%%{{{ generic / shared 

\definecolor{declarecolor}{cmyk}{1,0,0,0.5}

\DefStyle d {\sl}

\def\dterm#1{{\dstyle #1}}

\def\warningsign{{\sizex\bf !}}
\def\questionsign{{\sizex\bf ?}}

\def\activityhead{%
\eightbf
\ea\ea\ea\toupper\ea{\paragclassname}\enspace
{\ninebf \paragtag}%
\WhenStrNempty {\paragtitle} { {\ninebf (\paragtitle)}}%
\WhenStrNempty {\paragaka}   { {\ninebf (\paragaka)}}%
}

% XXX: enspace might not have the right size here
\def\rhang#1{\rlap{\enspace{\eightrm #1}}}

\def\moveqedup{\unskip\vskip-12pt}

%%{{{ ParagMacs

\DefAtomParagMac egsolution #1. #2\par{%
\eop\noi
\argumentationheadstylize{\IfStrEmpty{#1}{\sayName{solution}}{#1}. }%
#2%
\unskip
}

\DefAtomParagMac eganswer #1. #2\par{%
\eop\noi
\argumentationheadstylize{\IfStrEmpty{#1}{\sayName{answer}}{#1}. }%
#2%
\unskip
}

%%}}}

%%}}}

%%{{{ proclaim toolkit 

\DefStyle proclaim {\sl}
\DefStyle case              {\scshape}
\DefStyle proof             {\scshape}
\DefStyle proofpart         {\scshape}
\DefStyle proofalt          {\scshape}
\DefStyle argumentationhead {\scshape}

\def\relatessymbol{\raise.2ex\hbox{$\scriptstyle\triangleleft$}}
\def\teasessymbol{\raise.2ex\hbox{$\scriptstyle\triangleright$}}

%%{{{ \makeparagprovable 
\def\makeparagprovable{%
\let\noproof=\relax
\def\preproofhead   {}%
\def\preproofbody   {}%
\def\sketchhead     {}%
\def\sketchbody     {}%
\def\wrongproofhead {}%
\def\wrongproofbody {}%
\def\wrongproofref  {}%
\def\proofhead      {}%
\def\proofbody      {}%
\def\hideproof{\hideprooftrue}%
\def\headless{\headlesstrue}%
\innernewif\ifhideproof
\innernewif\ifheadless
\innernewif\ifpreproofhead
\innernewif\ifpreproofbody
\innernewif\ifsketchhead
\innernewif\ifsketchbody
\innernewif\ifwrongproofhead
\innernewif\ifwrongproofbody
\innernewif\ifwrongproofref
\innernewif\ifproofhead
\innernewif\ifproofbody
\LetParagMac preproof   = preproof
\LetParagMac sketch     = sketch
\LetParagMac wrongproof = wrongproof
\LetParagMac proof      = proof
}
%%}}}

%%{{{ Def provable ParagMacs 
\DefAtomParagMac preproof #1. #2\par{%
\def\preproofhead{#1}%
\def\preproofbody{#2}%
\ifx\NIL\preproofhead\else\preproofheadtrue\fi
\preproofbodytrue
}

\DefAtomParagMac wrongproof #1. #2\par{%
\def\wrongproofhead{#1}%
\def\wrongproofbody{#2}%
\def\check ##1 {\def\wrongproofref{\reftag[##1]}\wrongproofreftrue}%
\ifx\NIL\wrongproofhead\else\wrongproofheadtrue\fi
\wrongproofbodytrue
}

\DefAtomParagMac sketch #1. #2\par{%
\def\sketchhead{#1}%
\def\sketchbody{#2}%
\ifx\NIL\sketchhead\else\sketchheadtrue\fi
\sketchbodytrue
\hideprooftrue
}

\DefAtomParagMac proof #1. #2\par{%
\def\proofhead{#1}%
\def\proofbody{#2}%
%\StrExpand[0]{#2}{\proofbody}%
\ifx\NIL\proofhead\else\proofheadtrue\fi
\proofbodytrue
}
%%}}}

%%{{{ \doproofs 
\def\doproofs{%
%%%% if there is a preproof, show it
\ifpreproofbody
\eop
\bigskip
\noindent
\bgroup
\ifpreproofhead\noindent\argumentationheadstylize{\preproofhead}. \fi
\noindent
\preproofbody
\egroup
\eop
\bigskip
\fi
%%%% /if preproofbody
%%%% if there is a wrongproof, show it
\ifwrongproofbody % if wrongproof
\eop
\medskip
\noindent
\bgroup
\llap{\activitysymbol\enspace}%
\ifwrongproofhead\else\edef\wrongproofhead{\sayName{wrongproof}}\fi
\argumentationheadstylize{\wrongproofhead.\enspace}%
\wrongproofbody
\XXXeolllap{\mistakesymbol}%
\ifwrongproofref\rhang{\teasessymbol\enspace(\wrongproofref)}\fi
\egroup
\eop
\medskip
\fi
%%%% /if wrongproof
%%%% if there is a sketch, show it
\ifsketchbody % if sketch
\hideproof
\medskip
\endgraf\noindent
\llap{\activitysymbol\enspace}%
\argumentationheadstylize{\ifsketchhead\sketchhead\else\sayName{sketch}\fi}.
\bgroup
\sketchbody
\XXXeolfill\qessymbol % XXX: nolinebreak bad workaround
\ifproofbody\rhang{(\paragtag\reftagofid[\paragid_fullproof])\ifprint\enspace(\refpabbrofid[{\paragid_fullproof}])\fi}\fi
\egroup
\eop
\fi
%%%% /if sketch
%%%% if there is a proof, handle it
\ifproofbody
\ifproofhead\else\edef\proofhead{\sayName{proof}}\fi
%%%%%%%% if hideproof
\ifhideproof
\writefullproof
    {\number\chapterno}
    {\paragid}
    {\paragtag}
    {\unless\ifheadless{\unexpanded{\argumentationheadstyle}\proofhead.\enspace}\fi
     \ea\ea\ea\unexpanded\ea{\proofbody}\unexpanded{\hfill\qedsymbol}}%
\else % else (don't hide the proof, show it)
\medskip\endgraf\noindent
\bgroup
\ifheadless\else\argumentationheadstylize{\proofhead.\enspace}\fi
\proofbody
\XXXeolllap{\qedsymbol}%
\egroup
\endgraf
\fi
%%%%%%%% /if hideproof
\fi
%%%% /if proof
}
%%}}}

%%{{{ user toolkit 

% XXX: use better delims (. or : ?)
\def\case#1{\noindent\casestylize{#1}}
\def\proofpart#1{\noindent\proofpartstylize{#1}}
\def\crcase#1{\endgraf\case{#1}}
\def\crproofpart#1{\endgraf\proofpart{#1}}
\def\crtabcase#1{\endgraf\indent\case{#1}}
\def\crtabproofpart#1{\endgraf\indent\proofpart{#1}}
\def\proofalt#1{\noindent\proofaltstylize{#1}}
\def\crproofalt#1{\endgraf\proofalt{#1}}
\def\crtabproofalt#1{\endgraf\indent\proofalt{#1}}
\def\mistake{\hfill\mistakesymbol}%

%%}}}

%%}}}

%%{{{ activities toolkit 

\DefStyle activity     {\rm}

%%{{{ needed symbols for activities
\def\activitysymbol{\raise.4ex\hbox{$\scriptscriptstyle\blacktriangleright$}}
\def\qedsymbol{\vrule width .3em height 1.8ex depth .1ex\relax} % end of proof
\def\qecsymbol{\vrule width .3em height 1.8ex depth .1ex\relax} % end of construction
\def\qessymbol{\boxit{0pt}{\phantom{\qedsymbol}}} % end of sketch
\def\qexsymbol{\ensuremath{\bullet}} % end of example
\def\qepsymbol{\ensuremath{\fatsemi}} % end of program
\def\mistakesymbol{\ensuremath{\lightning}}
\def\qedword{{\scshape οεδ}}
\def\qecword{{\scshape οεπ}}
\def\qesword{{\scshape οες}}
\def\qedof#1.{\hfill\qedsymbol~(#1)} % we don't want to \rlap this
%%}}}

%%{{{ HINTS, SOLUTIONS, FULLPROOFS 

% skips
\Newskip hint=1\baselineskip;
\Newskip solution=2\hintskipamount;
\Newskip fullproof=\solutionskipamount;

% files
\newwrite\hintsfile
\newwrite\solutionsfile
\newwrite\fullproofsfile
\newwrite\symbolsfile
\immediate\openout\hintsfile=\jobname.hints
\immediate\openout\solutionsfile=\jobname.solutions
\immediate\openout\fullproofsfile=\jobname.proofs
\immediate\openout\symbolsfile=\jobname.symbols

% stylistic

\definecolor{hintstatuscolor}{cmyk}{0,0,0,.666}

\DefStyle hintstatus   {\color{hintstatuscolor}\sixrm}

\def\rhanghintstatus#1{\rlap{\raise.125ex\hbox{\hintstatusstylize{(\thinspace\structtag\thinspace \hinttagdecorator\thinspace#1)}}}}

\def\writesymbol#1#2#3#4{%
% 1: symbolid
% 2: symbol
% 3: pronunciation
% 4: pageno
\immediate\write\symbolsfile{%
\ea\string\csname symbolentry\endcsname
    {#1}
    {#2}
    {#3}
    {#4}
}%
}

\def\writehint#1#2#3{%
% 1: paragid
% 2: hint no
% 3: hint body
\immediate\write\hintsfile{%
\ea\string\csname hintentry\endcsname
    {#1}
    {#2}
    {#3}%
}%
}

\def\writesolution#1#2#3{%
% 1: paragid
% 2: chapterno
% 3: solution body
\immediate\write\solutionsfile{%
\ea\string\csname solutionentry\endcsname
    {#1}
    {#2}
    {#3}%
}%
}

\def\letpdef#1#2{\csgroup\csgroup\let\noexpand{#1}=\noexpand{#2}\relax}

\def\writefullproof#1#2#3#4{%
% 1: chapterno
% 2: paragid
% 3: paragtag (needed because of XXXnoproperreftext)
% 4: proof body
\immediate\write\fullproofsfile{%
\ea\string\csname fullproofentry\endcsname
    {#1}
    {#2}
    {#3}
    {#4}%
}%
}

%%}}}

%%{{{ \makeparagsolvable 
\def\makeparagsolvable{%
\hintno=0\relax
\LetParagMac hint     = hint
\LetParagMac solution = solution
\def\printhintstatus{%
\nobreak\XXXeolfill
% ifhints
\ifnum\hintno>0\relax % there are hints!
% calculate half of hintno
\rhanghintstatus{%
\ifprint
    \number\hintno
\else
    \global\hintstatusno=0\relax
    \loop
        \global\advance\hintstatusno by 1\relax
        {\sixrm\reftagofid[\paragid_hint_\number\hintstatusno]}\thinspace
        \ifnum \hintstatusno < \hintno \repeat
\fi % /ifprint
}
\else % no hints
\rhanghintstatus{0\thinspace}%
\fi % /ifhints
}%
}
%%}}}

%%{{{ Def solvable ParagMac 

\DefAtomParagMac hint #1\par{%
\advance\hintno by 1\relax
\ifnum \hintno > \maxhintno
\global\advance\maxhintno by 1\relax
\fi
\writehint
    {\paragid}
    {\number\hintno}
    {\unexpanded{#1}}%
}

\DefAtomParagMac solution #1\par{%
\writesolution
    {\paragid}
    {\number\chapterno}
    {\unexpanded{#1}}%
}

%%}}}

%%}}}

%%{{{ parag instances 

\SetParag blah nocounter    {}
\SetParag blah totalcounter {}
\SetParag blah head      {\IfStrEmpty{\paragtitle}{}{\paragtitle}}% simple \paragtitle won't do
\SetParag blah headyhook {\IfStrEmpty{\paragtitle}{}{.}}
\SetParag blah headzhook {\IfStrEmpty{\paragtitle}{}{\enspace}}
\SetParag blah bodybhook {\loadeqnumber\aftergroup\saveeqnumber\noindent}
\SetParag blah tag          {¶}
\SetParag blah tagdecorator {}
\DefAParag blah

\SetParag note head {\paragtag\WhenStrNempty{\paragtitle}{. \paragtitle}}
\DefAParag note

\SetParag question tagdecorator  {Q}
\SetParag question asymbol       {\questionsign}
\DefAParag question

\DefAParag remark

\SetParag warning asymbol {\warningsign}
\DefAParag warning

\SetParag beware asymbol {\warningsign}
\DefAParag beware

\DefAParag advice

\SetParag primitive tagdecorator {P}
\DefAParag primitive

\SetParag definition tagdecorator {D}
\DefAParag definition

\SetParag pseudodefinition tagdecorator {D}
\DefAParag pseudodefinition

\SetParag grammar tagdecorator {Γ}
\DefAParag grammar

\SetParag algorithm tagdecorator {a}
\DefAParag algorithm

\SetParag notation tagdecorator {D}
\DefAParag notation

\SetParag specification tagdecorator {S}
\DefAParag specification

\DefAParag teaser

\DefAParag joke

\SetParag implementation tagdecorator {D}
\DefAParag implementation

\SetParag answer tagdecorator {A}
\DefAParag answer

% for stand-alone proofs (usually with an \of ...)
\SetParag proof headbhook       {\proofstyle}
\SetParag proof tagbhook        {\bf}
\SetParag proof zsymbol         {\qedsymbol}
\DefAParag proof

% for stand-alone refutations (usually with an \of ...)
\SetParag refutation headbhook      {\proofstyle}
\SetParag refutation tagbhook       {\bf}
\SetParag refutation zsymbol        {\qedsymbol}
\DefAParag refutation

%%{{{ Egparags 
% egpags are delimited and have their own solution and answer macros

\def\DefEgparag #1 {%
\SetParag #1 asymbol   {\qexsymbol}
\SetParag #1 head      {\activityhead}
\SetParag #1 headzhook {\newline\nobreak}
\SetParag #1 bodymacros {%
\LetParagMac solution = egsolution
\LetParagMac answer   = eganswer
}
\DefMParag #1
}

\DefEgparag example
\DefEgparag nonexample

%%}}}

%%{{{ Provables 

\def\DefProvable #1: #2 {%
\SetParag #2 tagdecorator {#1}
\SetParag #2 bodymacros   {\makeparagprovable}
\SetParag #2 bodybhook    {\proclaimstyle}
\SetParag #2 bodyyhook    {\rm\doproofs}
\DefMParag #2
}

\DefProvable Θ: theorem
\DefProvable Λ: lemma
\DefProvable  : property
\DefProvable  : criterion
\DefProvable  : corollary
\DefProvable  : proposition

% Unprovables:

\SetParag conjecture tagdecorator {?}
\SetParag conjecture bodybhook {\proclaimstyle}
\DefAParag conjecture

\SetParag axiom tagdecorator {α}
\SetParag axiom bodybhook {\proclaimstyle}
\DefAParag axiom

\SetParag hypothesis bodybhook {\proclaimstyle}
\DefAParag hypothesis

\SetParag principle bodybhook {\proclaimstyle}
\DefAParag principle

\SetParag law bodybhook {\proclaimstyle}
\DefAParag law

%%}}}

%%{{{ Solvables 
% here a Set..Mixin meta-setter to allow for further customization

\def\SetSolvableMixin #1: #2 {%
\SetParag #2 tagdecorator {#1}
\SetParag #2 nocounter    {\csgroup{#2no}}
\SetParag #2 totalcounter {\csgroup{#2total}}
\SetParag #2 asymbol      {\activitysymbol}
\SetParag #2 head         {\activityhead}
\SetParag #2 headzhook    {\newline}
\SetParag #2 bodymacros   {\makeparagsolvable}
\SetParag #2 bodybhook    {\activitystyle}
\SetParag #2 bodyyhook    {\printhintstatus}
}

\SetSolvableMixin x: exercise
\DefMParag exercise

\SetSolvableMixin Π: problem
\DefMParag problem

\SetSolvableMixin c: codeit
\DefMParag codeit

\SetSolvableMixin Π: openproblem
\SetParag openproblem nocounter    {\problemno}
\SetParag openproblem totalcounter {\problemtotal}
\DefMParag openproblem

%%}}}

%%}}}

%%}}}

%%{{{ sourcecode listing 
\definecolor{sourcecodelinecolor}{cmyk}{0,0,0,.5}
\definecolor{sourcecodelinecolorinv}{cmyk}{0,0,0,.1}
\DefStyle sourcecodeline {\sf}
\def\printlistinglineno{\hbox{\hbox to 4em{}\llap{\colorboxfb{sourcecodelinecolor}{sourcecodelinecolorinv}{\hbox to 1em{}\sizeviii\sf\twopadthe\lineno}}\quad}}
\def\sourcecode#1; {\endgraf\bigskip{\sizex\def\setuplistinghook{\linenumberedlisting\nolastlinelisting}\listing{code/#1}}\bigskip\endgraf\noindent}
%%}}}

\endinput


# Examples

\theorem Fundamental Theorem of Arithmetic.
\headerize
\aka unique factorization.
\label fundamental_theorem_of_arithmetic
\defines
    * ~f : ~A \to ~B -- $f$ is a function from $A$ to $B$
    * ~A \inter ~B   -- the intersection of $A$ and $B$
    * homomorphism
    ;;
\indexes
    * theorem!fundamental of arithmetic
    * theorem!fundamental of arithmetic     seealso: factorization
    * fundamental theorem                       see: theorem, fundamental
    ;;
% note that the credited must be a friend
\credits
    * Cantor : paradise
    ;;
\pdefs
    \pdef csn ####1...{...}   % <- no need to % the newline
    ;;

Bla bla bla.

Optionally now:

\preproof.
...

\wrongproof.
\check optional_label_here_to_refer_to
...

\sketch.
...

And now either \noproof or

\proof Won't be shown, not even the period.
\headless
...


% there is a proof parag for standalone proofs
\proof Demonstração alternativa.
\of lagrange_theorem

blabla
blab lla bla


