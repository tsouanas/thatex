%%{{{ [vim] 
%% vim:foldmarker=%{{{,%}}}
%% vim:foldmethod=marker
%% vim:foldcolumn=6
%%}}}
%% thatexbook.tex
%% author: Thanos Tsouanas <thanos@tsouanas.org>

%%{{{ Frontmatter 

%%{{{ short toc 
\def\printshorttoc{{
\oddpage\titlepagetrue
\baselineskip=18pt
%\def\tocchapterentry##1##2##3{{\line{\llap{{##2}.~}##1\dotfill##3}}}
\def\tocchapterentry##1##2##3{{\line{\llap{{##2}.~}##1\dotfill\hlprintpage{##3}}}}
\def\tocappendixentry##1##2##3{{\line{\llap{{\Alphabetnumeral##2}.~}##1\dotfill\hlprintpage{##3}}}}
\def\tocchapteroidentry##1##2{{\line{##1\dotfill\hlprintpage{##2}}}}
\def\tocsectionentry##1##2##3{}
\def\tocsectionoidentry##1##2{}
{\larger\bf
\parindent=0pt
\baselineskip=16pt
\centerline{\fourteenrm\toupper{\shorttocname}}
\vskip\chapteroidtitleskip
\readtocfile
}
\vfil
\eject
}}
%%}}}

%%{{{ long toc 
\def\printlongtoc{{
\oddpage
\titlepagetrue
\nodecorspage
\def\tocchapterentry##1##2##3{{\bf\vskip 2ex\line{\llap{{##2}.~}##1\enspace\hrulefill\enspace\hlprintpage{##3}}}\vskip 1ex}
\def\tocappendixentry##1##2##3{{\bf\vskip 2ex\line{\llap{{\Alphabetnumeral##2}.~}##1\enspace\hrulefill\enspace\hlprintpage{##3}}}\vskip 1ex}
\def\tocchapteroidentry##1##2{{\bf\vskip 2ex\line{##1\enspace\hrulefill\enspace\hlprintpage{##2}}}\vskip 1ex}
\def\tocsectionentry##1##2##3{{\line{{\qquad} \llap{\S##2.~}{##1}{\dotfill}{\hlprintpage{##3}}\qquad\qquad}}}
\def\tocsectionoidentry##1##2{{\line{{\qquad} {##1}{\dotfill}{\hlprintpage{##2}}\qquad\qquad}}}
{
\parindent=0pt
\centerline{\fourteenrm\toupper{\tocname}}
\vskip\chaptertitleskip
\readtocfile
}
\vfil
\eject
}}
%%}}}

%%{{{ list of algorithms 
\def\printloa{{% TODO
\chapteroid \loaname.

\endchapteroid
}}
%%}}}

%%{{{ list of code 
\def\printloc{{% TODO
\chapteroid \locname.

\endchapteroid
}}
%%}}}

%%}}}

%%{{{ Appendices 

%%{{{ Part pages 
\def\printpartpage#1{{
\partpage
\hbox{}\vfil
\twentyfourbf
\centerline{#1}
\titlepagetrue
\vfil
\vfil
\eject
}}
%%}}}

%%{{{ Proofs 
\def\printproofsappendix{%
\appendix \proofsname.

{%
\immediate\closeout\fullproofsfile
\innernewcount\curchapterno

\def\fullproofentry##1##2##3##4{%
\ifnum##1>\curchapterno
\curchapterno=##1
\centerline{\fourteenbf\chaptername~##1}\vskip\fullproofskip
\fi
\noindent{\bf \refn{##3}.}
\xrdef{##3_fullproof}%
##4
\goodbreak\vskip\fullproofskip
}

\safereadfile{proofs}
}

\endappendix
}
%%}}}

%%{{{ Hints 
\def\printhintsappendix{%
\appendix \hintsname.

{%
\immediate\closeout\hintsfile
\input repeat
\repeat \for{i} \from{1} \to{\maxhintno} \do{
\expandafter\hintsection \number\i.
\hldestizepage%

\def\hintentry##1##2##3##4##5##6{%
\ifnum\number\i=##5
\noindent{\llap{\bf \refn{##4}.~}}%
{\scshape\hintname~\oldstyle{##5}:}
\definexref{##4_hint_##5}{##5}{hint}%
##6
%
\goodbreak
\vskip\hintskip
\fi
\goodbreak
}

\safereadfile{hints}

\endhintsection
}% end repeat
}

\endappendix
}
%%}}}

%%{{{ Solutions 
\def\printsolutionsappendix{%
\appendix \solutionsname.

{%
\immediate\closeout\solutionsfile
\innernewcount\curchapterno

\def\solutionentry##1##2##3##4##5{%
\ifnum##2>\curchapterno
\curchapterno=##2
\centerline{\fourteenbf\chaptername~##2}\vskip\solutionskip
\fi
\noindent\llap{\bf \refn{##4}.\enspace}%
##5
\vskip\solutionskip
}

\safereadfile{solutions}
}

\endappendix
}
%%}}}

%%{{{ Program code 
\def\printcodeappendix{%
\appendix Código de programas.

\safereadfile{programs}

\endappendix
}
%%}}}

%%}}}

%%{{{ Backmatter 

%%{{{ References 
\def\printreferenceswith#1{%
\chapteroid \referencesname.

\bibliographystyle{alpha}
\bibliography{#1}

\endchapteroid
}
%%}}}

%%{{{ Symbol glossary 
\def\printsymbolglossary{%
\chapteroid \symglossaryname.

{%
\immediate\closeout\symbolsfile
\multiply\baselineskip by 2

\def\symbolentry##1##2##3##4##5##6##7{%
\line{\llap{##6}\quad\hbox{##7}\quad\dotfill{}\enspace{{\ref{##5},}\rlap{\enspace{\bf ##4}}}}%
}

\safereadfile{symbols}

}

\endchapteroid
}
%%}}}

%%{{{ Index of names 
\def\printindexofnames{%
\chapteroid \nameindexname.

\readindexfile n

\endchapteroid
}
%%}}}

%%{{{ Index of terms 
\def\printindexofterms{%
\chapteroid \indexname.

\readindexfile i

\endchapteroid
}
%%}}}

%%}}}

%%{{{ general-style 

%%{{{ page layout 

% top-level strings
%%%% A4:     210mm x 297mm
%%%% A5:     148mm x 210mm
%%%% letter: 8.5in x 11in

%\paperheight=297mm
%\paperwidth=210mm

% margins (THESE ARE NOT REGISTERS, see eplain)
\topmargin=26mm
\bottommargin=28mm
\leftmargin=34mm
\rightmargin=34mm

\normalbaselineskip=12pt \sizexi\rm

%\hsize=210mm
%\vsize=297mm
%\advance\hsize by -3in
%\advance\vsize by -3in

%%}}} 

%%{{{ draft / release versions
\ifdraft
\overfullrule=2cm
\else\overfullrule=0pt
\fi
%%}}}

%%}}}

%%{{{ Symbols 
\def\activitysymbol{{\manual\char'170}}
\def\examplesymbol{{$\bullet$}}
%%}}}

%%{{{ \Report 
\def\makereport{%
\Report
\WriteReport{exercises}{\the\exercisetotal}
\WriteReport{problems}{\the\problemtotal}
\WriteReport{chapters}{\the\chaptertotal}
\WriteReport{sections}{\the\sectionno}
\WriteReport{pages}{\the\pageno}
\EndReport
}
%%}}}

%%{{{ indices 
%\defineindex i % this is already defined by eplain
\defineindex n % friends
\def\idxpmdefpage#1{{\bf #1}}
%\def\idxpminfopage#1{{\it #1}}
\indexproofingfalse % default is false anyway
\hookaction{beginindex}{\doublecolumns}
\def\indexfonts{\sizex}
%%}}}

%%{{{ biblio 
\def\printcitestart{\bgroup[\ninessdc}
\def\printcitefinish{]\egroup}
\def\printcitenote#1{\ninerm:~{\relax#1}}
\def\printbetweencitations#1{{\ninesl,}~}
%%}}}

%%{{{ rosters 
\let\listmarkerspace=\enspace
\listleftindent=.5\parindent
\def\numberedprintmarker#1{\llap{(#1) \listmarkerspace}}
%%}}}

%%{{{ text structures 

% top-level counters
\newcount\chapterno
\newcount\appendixno
\newcount\sectionno
\newcount\noteno
\newcount\exerciseno
\newcount\codeitno
\newcount\problemno
\newcount\hintno
\newcount\maxhintno
\newcount\symbolno

% \WriteReport counters
\newcount\exercisetotal
\newcount\problemtotal
\newcount\chaptertotal
\exercisetotal=0
\problemtotal=0
\chaptertotal=0

%%{{{ spoilers 
\def\spoiler#1.{% TODO
\nobreak\vfill
\nobreak\centerline{{\color{spoiler}\hrulefill\quad\bf!!~SPOILER ALERT~!!\quad\hrulefill}}
\nobreak\vfill
\bigskip
\break
}
%%}}}

%%{{{ chapter 
\newskip\chaptertitleskip
\newskip\chapteroidtitleskip
\chaptertitleskip=8ex
\chapteroidtitleskip=6ex

% styles
\def\chapterwordstyle#1{\twelverm\toupper{#1}}
\def\chaptertitlestyle#1{\twelverm\toupper{#1}}
\def\chapteroidtitlestyle#1{\fourteenbf\vphantom{ÂÇ}#1}

\def\chapter#1. #2\par{%
\global\advance\chapterno by 1%
\global\advance\chaptertotal by 1\relax%
\titlepage%
\topmarker={\chaptername~\number\chapterno}%
\toptitle={#1}%
\noteno=0%
\exerciseno=0%
\codeitno=0%
\problemno=0%
{%
\def\chaptertag{\number\chapterno}%
\def\label##1{\definexref{##1}{\chaptertag}{chapter}\xrdef{p:##1}}%
#2%
\hldestizepage%
\writenumberedtocentry{chapter}{#1}{\number\chapterno}%
\vglue 4ex%
\centerline{\chapterwordstyle{\chaptername}~\Romannumeralof{\the\chapterno}}%
\vglue 4ex%
\centerline{\chaptertitlestyle{#1}}\par%
\vglue\chaptertitleskip%
}%
}

\def\endchapter{%
\vfill$$\woohoo$$\eject%
}

\def\appendix#1. #2\par{%
\global\advance\appendixno by 1%
\titlepage%
\topmarker={\appendixname~\Alphabetnumeral{\appendixno}}%
\toptitle={#1}%
\noteno=0%
\exerciseno=0%
\codeitno=0%
\problemno=0%
{%
\def\appendixtag{\number\appendixno}%
\def\label##1{\definexref{##1}{\appendixtag}{appendix}\xrdef{p:##1}}%
#2%
\hldestizepage%
\writenumberedtocentry{appendix}{#1}{\number\appendixno}%
\hbox{}\vskip 4ex
\centerline{\chapterwordstyle{\appendixname}~\Alphabetnumeral{\appendixno}}
\vskip 4ex
\centerline{\chaptertitlestyle{#1}}\par
\vskip\chaptertitleskip
\noindent
}
}

\def\endappendix{%
\vfill\eject%
}

\def\chapteroid#1. #2\par{%
\titlepage%
\oddpage%
\toptitle={#1}%
\topmarker={#1}%
\noteno=0%
\exerciseno=0%
\codeitno=0%
\problemno=0%
{%
\def\label##1{\xrdef{p:##1}}%
#2%
\hldestizepage%
\writetocentry{chapteroid}{#1}{}%
\hbox{}\vskip 4ex
\centerline{\chapteroidtitlestyle{#1}}\par
\vskip.5ex\hrule 
\vskip\chapteroidtitleskip
\noindent
}
}

\def\endchapteroid{%
\vfill$$\woohoo$$%
\makenextpageodd%
}

%%}}}

%%{{{ section 
\newskip\sectiontitleskip
\sectiontitleskip=.333\chaptertitleskip
\def\section#1. #2\par{%
\global\advance\sectionno by 1%
{%
\def\sectiontag{\knuthS\the\sectionno}%
\def\label##1{\definexref{##1}{\sectiontag}{section}\xrdef{p:##1}}%
\writenumberedtocentry{section}{#1}{\the\sectionno}%
\centerline{\twelvebf{\sectiontag.~}#1}%
\hldestizepage%
\bgroup%
\noindent%
#2%
}%
}

\def\endsection{%
\egroup%
\par\vskip 8ex\relax\goodbreak
}
%%}}}

%%{{{ sectionoids 

% generic 
\def\sectionoidwrapper#1#2{%
{%
\medbreak\goodbreak\noindent%
{%
\centerline{\fourteenbf#1}\nopagebreak%
\immediate\writetocentry{sectionoid}{#1}{}%
\hldestizepage\vskip\sectiontitleskip\par\nopagebreak%
}%
\noindent#2%
}%
}

\def\sectionoid#1. #2\par{%
{%
\sectionoidwrapper{#1}{#2}%
}%
}

\def\endsectionoid{%
\vskip 4ex\relax\goodbreak
}

\def\problems#1. #2\par{%
\sectionoidwrapper{\ifEqStr{#1}{}\problemsname\else#1\fi}{#2}%
}

\def\endproblems{%
\endsectionoid
}

\def\further#1. #2\par{%
\sectionoidwrapper{\ifEqStr{#1}{}\furthername\else#1\fi}{#2}%
}

\def\endfurther{%
\endsectionoid
}

\def\history#1. #2\par{%
\sectionoidwrapper{\ifEqStr{#1}{}\historyname\else#1\fi}{#2}%
}

\def\endhistory{%
\endsectionoid
}


\def\hintsection#1. #2\par{%
\def\hintsectiontitle{\hintsname\ \##1}
\sectionoidwrapper{\hintsname\ \##1}{#2}
}

\def\endhintsection{%
\endsectionoid
\goodbreak
}


%%}}}

%%}}}

%%{{{ math structure 

%%{{{ xrefs 
\def\eqconstruct#1{\the\chapterno{.}#1}
\def\taglabel#1#2{\tag{#1}\definexref{#2}{#1}{math}}
\def\axtaglabel#1#2{\taglabel{#1}{ax_#2}}
\def\axref#1{\ensuremath{\text{\ref{ax_#1}}}}
%%}}}

%%{{{ needed symbols 
\def\qedsymbol{\vrule width .3em height 1.8ex depth .1ex\relax}
\def\qecsymbol{\vrule width .3em height 1.8ex depth .1ex\relax}
\def\qessymbol{\boxit{0pt}{\phantom{\qedsymbol}}}
\def\qexsymbol{\ensuremath{\bullet}}
\def\qepsymbol{\ensuremath{\fatsemi}}
\def\mistakesymbol{\ensuremath{\lightning}}
\def\qedword{{\scshape οεδ}}
\def\qecword{{\scshape οεπ}}
\def\qesword{{\scshape οες}}
%%}}}

%%{{{ proclamations 

\def\moveqedup{\unskip\vskip-12pt}
\def\notemixin{
\def\notecounter{\noteno}%
\def\notecounterinc{\global\advance\notecounter by 1\relax}%
\def\notecounterdec{\global\advance\notecounter by -1\relax}%
\def\notetagdecorate##1{##1}
\def\notetag{\notetagdecorate{\the\chapterno.\the\notecounter}}%
\def\notename{}%
\def\noterefclass{}%
\def\notehead{\medbreak\noindent\bgroup\bf\notetag.~\ifEmpty\notename\else\notename.\enspace\fi\egroup}%
\def\notebodyahook{\bgroup}%
\def\notebodyzhook{\egroup\par\medbreak}%
\def\notebodytext{}%
\def\notebody{\notebodyahook\notebodytext\notebodyzhook}%
}

\def\note#1. #2\par{%
{%
\notemixin%
% overrides:
\notecounterinc%
\def\notename{#1}%
\def\notebodytext{%
\def\label####1{\definexref{####1}{\notetag}{note}}%
#2
}%
\def\notekind{note}%
% print it:
%\notehead%
\medbreak%
\noindent%
{\bf\notetag.\enspace%
\ifEmpty\notename\else\notename.\enspace\fi}%
\notebody%
}%
}

\def\gennote#1#2#3#4{
% #1: name of note (theorem)
% #2: title (Thales)
% #3: body
% #4: tag decorator
{%
\notemixin%
% overrides:
\def\notekind{#1}
\def\notetagdecorate##1{#4##1}
\notecounterinc%
\ifnull#2\\%
\edef\notename{\csname#1name\endcsname}%
\else%
\edef\notename{\csname#1name\endcsname~(#2)}%
\fi%
\def\notelabel{note\notetag}
\def\label##1{\definexref{##1}{\notetag}{note}}%
\def\notebodytext{%
\def\label####1{\definexref{####1}{\notetag}{#1}}%
%%%%%%%
#3%
}%
\expandafter\label{\notelabel}%
\notehead%
\notebody%
}%
\medbreak
}

\def\proclaimstyle{\sl}
\def\genproclaim#1#2#3#4{%
% #1: name of note (theorem)
% #2: title (Thales)
% #3: body
% #4: tag decorator
\gennote{#1}{#2}{%
\innernewif\ifhideproof%
\hideprooffalse%
%%%%
% sketch
\long\def\sketch####1. ####2\qes{%
\hideprooftrue%
\medskip
\endgraf\noindent%
\llap{\activitysymbol\enspace}%
\ifEqStr{####1}{}%
\argumentationheadstyle{\sketchname}. %
\else%
\argumentationheadstyle{####1}. %
\fi%
\bgroup\rm%
####2%
\eolfill\qessymbol%
\egroup%
}%
%%%%
% wrongproof 
\long\def\wrongproof####1. ####2\mistaqed{%
\hideprooftrue%
\endgraf\noindent%
\bgroup\rm%
\ifEqStr{####1}{}%
\argumentationheadstyle{\llap{\activitysymbol\enspace}\proofname}. %
\else%
\argumentationheadstyle{\llap{\activitysymbol\enspace}####1}. %
\fi%
####2%
{\hfill\mistakesymbol}%
\egroup%
\endgraf%
}%
%%%%
% proof 
\long\def\proof####1. ####2\qed{%
\ifEqStr{####1}{}%
\def\proofhead{\proofname. }%
\else%
\def\proofhead{####1}%
\fi%
\ifhideproof%
\rlap{~{\eightrm (\xrefn[p.]{\notelabel_fullproof})}}%
\immediate\writefullproof{\number\chapterno}{\notetag}{\notelabel}{{\unexpanded{\scshape} \proofhead}\unexpanded{####2}\unexpanded{\hfill\qedsymbol}}%
\else%
\endgraf\noindent%
\bgroup\rm%
%
\argumentationheadstyle{\proofhead}%
####2%
{\hfill\qedsymbol}%
\egroup%
\endgraf%
\fi%
}%
\proclaimstyle#3}{#4}%
}

\def\theorem#1. #2\par{\genproclaim{theorem}{#1}{#2}{Θ}}
\def\lemma#1. #2\par{\genproclaim{lemma}{#1}{#2}{Λ}}
\def\proposition#1. #2\par{\genproclaim{proposition}{#1}{#2}{}}
\def\property#1. #2\par{\genproclaim{property}{#1}{#2}{}}
\def\corollary#1. #2\par{\genproclaim{corollary}{#1}{#2}{}}
\def\conjecture#1. #2\par{\genproclaim{conjecture}{#1}{#2}{}}
\def\question#1. #2\par{\genproclaim{question}{#1}{#2}{}}
\def\axiom#1. #2\par{\genproclaim{axiom}{#1}{#2}{}}
\def\principle#1. #2\par{\genproclaim{principle}{#1}{#2}{}}
\def\criterion#1. #2\par{\genproclaim{criterion}{#1}{#2}{}}
\def\algorithm#1. #2\par{\gennote{algorithm}{#1}{#2}{}}
\def\program#1. #2\par{\gennote{program}{#1}{#2}{}}
\def\remark#1. #2\par{\gennote{remark}{#1}{#2}{}}
\def\beware#1. #2\par{\gennote{beware}{#1}{#2}{}}
\def\warning#1. #2\par{\gennote{warning}{#1}{#2}{}}
\def\definition#1. #2\par{\gennote{definition}{#1}{#2}{D}}
\def\blah#1. #2\par{\medskip#2\medskip}

\def\algospec INPUT: #1 OUTPUT: #2\endspec{%
\halign{%
\hfil##&##\hfil\cr
\casestyle{\algoinputname:}  & #1\cr
\casestyle{\algooutputname:} & #2\cr
}
}

\definecolor{declarecolor}{cmyk}{1,0,0,0.5}
\def\dstyle#1{{\sl #1}}
\def\dsym#1{#1}%
\def\dterm#1{%
\dstyle{#1}%
}

%%{{{ Indexing commands 
\def\sdefined#1#2{%
\global\advance\symbolno by 1\relax%
\definexref{symbol\number\symbolno}{\notetag}{\notekind}%
\immediate\writesymbol%
{\number\chapterno}%1
{\notetag}%2
{\notekind}%3
{\number\pageno}%4
{symbol\number\symbolno}%5
{\unexpanded{\ensuremath{#1}}}%6
{\unexpanded{#2}}%7
}
\def\tdefined#1{%
\sidx[pagemarkup=idxpmdefpage]{#1}%
}
\def\ii{\sidx}
\def\iisee{\sidx[see]}
\def\iiseealso{\sidx[seealso]}
\def\nameindex#1#2{%
\sndxname{#1}{#2}%
}
%%}}}

%%}}}

%%{{{ HINTS, SOLUTIONS, AND FULLPROOFS 
\newskip\hintskip
\newskip\solutionskip
\newskip\fullproofskip
\hintskip=1\baselineskip\relax
\solutionskip=2\hintskip\relax
\fullproofskip=\solutionskip\relax

\newwrite\hintsfile
\newwrite\solutionsfile
\newwrite\fullproofsfile
\newwrite\symbolsfile
\immediate\openout\hintsfile=\jobname.hints
\immediate\openout\solutionsfile=\jobname.solutions
\immediate\openout\fullproofsfile=\jobname.proofs
\immediate\openout\symbolsfile=\jobname.symbols

\def\writesymbol#1#2#3#4#5#6#7{%
% #1: chapterno
% #2: notetag (3.2)
% #3: notekind (definition)
% #4: pageno
% #5: symbolno
% #6: symbol
% #7: pronunciation
\write\symbolsfile{%
\expandafter\string\csname symbolentry\endcsname
    {#1}
    {#2}
    {#3}
    {#4}
    {#5}
    {#6}
    {#7}
}%
}
\def\writehint#1#2#3#4#5#6{%
% #1: group (exercise or problem)
% #2: chapterno
% #3: tag (x4.2)
% #4: label (exercise_x4.2)
% #5: count (4)
% #6: hint text
\write\hintsfile{%
\expandafter\string\csname hintentry\endcsname
    {#1}
    {#2}
    {#3}
    {#4}
    {#5}
    {#6}
}%
}

\def\writesolution#1#2#3#4#5{%
% #1: group (exercise or problem)
% #2: chapterno
% #3: tag (x4.2)
% #4: label (exercise_x4.2)
% #5: solution text
\write\solutionsfile{%
\expandafter\string\csname solutionentry\endcsname
    {#1}
    {#2}
    {#3}
    {#4}
    {#5}
}%
}

\def\writefullproof#1#2#3#4{%
% #1: chapterno
% #2: tag (Θ4.2, Λ3.2, etc.)
% #3: label (8.23)
% #4: proof text
\write\fullproofsfile{%
\expandafter\string\csname fullproofentry\endcsname
    {#1}
    {#2}
    {#3}
    {#4}
}%
}

%%}}}

%%{{{ exercise 
\long\def\exercise#1. #2\par#3\endexercise{%
% #1: title
% #2: body
% #3: hints and solution
\global\advance\exerciseno by 1\relax%
\global\advance\exercisetotal by 1\relax%
\hintno=0
{% exercise-scope
\def\exercisetag{x\the\chapterno.\the\exerciseno}%
\def\exerciselabel{x\the\chapterno.\the\exerciseno}%
\def\label##1{\definexref{##1}{\exercisetag}{exercise}}%
\smallbreak\noindent%
\llap{\activitysymbol\enspace}%
\leftline{\eightbf \toupper{\exercisename}~{\ninebf \exercisetag}\ifnull#1\\\else~{\ninebf (#1)}\fi.}%
\expandafter\label{\exerciselabel}%
\break
\bgroup%
% hints
\def\printhintstatus{%
\eolfill%
\ifnum\hintno>0%
\hintstatusstyle{%
\ifprint
\number\hintno
\else%
\count1=0
\loop%
\advance\count1 by 1
\xref{\exerciselabel_hint_\number\count1}%
\thinspace%
\ifnum\count1<\hintno
\repeat
\fi % /ifprint
}
\else
\hintstatusstyle{0}
\fi
}
\def\hint##1\par{%
\advance\hintno by 1\relax%
\ifnum\hintno>\maxhintno%
\global\advance\maxhintno by 1\relax%
\fi
\immediate\writehint{exercise}{\number\chapterno}{\exercisetag}{\exerciselabel}{\number\hintno}{\unexpanded{##1}}%
}
% solution
\def\solution##1\par{%
\immediate\writesolution{exercise}{\number\chapterno}{\exercisetag}{\exerciselabel}{\unexpanded{##1}}%
}%
#2% output body
#3% process hints
\printhintstatus%
\par\egroup\medbreak
}% /exercise-scope
}
%%}}}

%%{{{ example 
\long\def\example#1. #2\endexample{%
\global\advance\noteno by 1\relax%
{% example-scope 
\def\exampletag{\the\chapterno.\the\noteno}%
\def\examplelabel{eg\the\chapterno.\the\noteno}%
\def\label##1{\definexref{##1}{\exampletag}{example}}%
\smallbreak\noindent%
\llap{\examplesymbol\enspace}%
\leftline{\eightbf \toupper{\examplename}~{\ninebf \exampletag}\ifnull#1\\\else~{\ninebf (#1)}\fi.}%
\expandafter\label{\examplelabel}%
\break
\bgroup%
\def\label##1{\definexref{##1}{\exampletag}{example}}% label for example body 
% solution
\def\solution##1\par{%
\noindent%
%\ifEqStr{##1}{}% In case we switch to "\solution." and "\solution Resposta." etc.
%\argumentationheadstyle{\solutionname}. %
%\else%
%\argumentationheadstyle{##1}%
%\fi%
\argumentationheadstyle{\solutionname}. %
{##1}
}%
#2%
\eolfill$\qexsymbol$\par\egroup\medbreak
}% /example-scope
}
%%}}}

%%{{{ codeit 
\long\def\codeit#1. #2\endcodeit{%
\global\advance\codeitno by 1\relax%
\hintno=0
\def\codeittag{c\the\chapterno.\the\codeitno}%
\smallbreak\noindent%
\llap{\activitysymbol\enspace}%
\leftline{\eightbf \toupper{\codeitname}~{\ninebf \codeittag}\ifnull#1\\\else~{\ninebf (\;{\ninett #1}\;)}\fi.}\break
\bgroup
\def\label##1{%
\definexref{##1}{\codeittag}{codeit}%
}%
% hints
\def\hint##1\par{%
\advance\hintno by 1\relax%
\ifnum\hintno>\maxhintno%
\global\advance\maxhintno by 1\relax%
\fi
\immediate\writehint{codeit}{\number\chapterno}{\codeittag}{\codeitlabel}{\number\hintno}{\unexpanded{##1}}%
}
#2
\par\egroup\medbreak
}
%%}}}

%%{{{ problem 
\long\def\problem#1. #2\par#3\endproblem{%
% #1: title
% #2: body
% #3: hints and solution
\global\advance\problemno by 1\relax%
\global\advance\problemtotal by 1\relax%
\hintno=0
{% problem-scope
\def\problemtag{Π\the\chapterno.\the\problemno}%
\def\problemlabel{Pi\the\chapterno.\the\problemno}%
\def\label##1{\definexref{##1}{\problemtag}{problem}}%
\medbreak\noindent%
\llap{\activitysymbol\enspace}%
\leftline{\eightbf \toupper{\problemname}~{\ninebf \problemtag}\ifnull#1\\\else~{\ninebf (#1)}\fi.}%
\expandafter\label{\problemlabel}%
\break
\bgroup%
% hints
\def\printhintstatus{%
\eolfill%
\ifnum\hintno>0%
\hintstatusstyle{%
\ifprint%
\number\hintno
\else
\count1=0
\loop
\advance\count1 by 1
\xref{\problemlabel_hint_\number\count1}%
\thinspace%
\ifnum\count1<\hintno
\repeat
\fi % /ifprint
}
\else
\hintstatusstyle{0}
\fi
}
\def\hint##1\par{
\advance\hintno by 1\relax
\ifnum\hintno>\maxhintno%
\global\advance\maxhintno by 1\relax%
\fi
\immediate\writehint{problem}{\number\chapterno}{\problemtag}{\problemlabel}{\number\hintno}{\unexpanded{##1}}
}
% solution
\def\solution##1\par{%
\immediate\writesolution{problem}{\number\chapterno}{\problemtag}{\problemlabel}{\unexpanded{##1}}%
}%
#2%
#3%
\printhintstatus%
\par\egroup%
}% /exercise-scope
}
%%}}}

%%{{{ argumentations 

\def\argumentationheadstyle#1{{\scshape #1}}
\def\casestyle#1{{\noindent\scshape #1}}
\def\proofstyle#1{{\noindent\scshape #1}}
\def\mistake{\hfill\mistakesymbol}%

%%}}}

%%{{{ report 

\newwrite\reportfile
\def\Report{\immediate\openout\reportfile=\jobname.report}
\def\WriteReport#1#2{\write\reportfile{#1:#2}}
\def\EndReport{\closeout\reportfile}

%%}}}

%%}}}

