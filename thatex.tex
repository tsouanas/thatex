%{{{ [vim] 
% vim:foldmarker=%{{{,%}}}
% vim:foldmethod=marker
% vim:foldcolumn=4
%}}}
%% thatex.tex
%% author: Thanos Tsouanas <thanos@tsouanas.org>

\message{[ThaTeX]}

%%{{{ \inputs 

% eplain
\let\noarrow=t
\input eplain
\let\noarrow\relax

% these must be loaded before the following LaTeX packages
\input bussproofs.sty
\input xkeyval

% LaTeX packages
\beginpackages
\usepackage{url}
\usepackage[dvipsnames]{color}
\usepackage{graphicx}
\endpackages

% protect colors from tiks/pgfmath 
\let\eplaincolor\color
\let\eplaindefinecolor\definecolor
\input tikz % includes pgffor and pgfkeys
\input pgfplots
\usetikzlibrary{shapes}
\let\color\eplaincolor
\let\definecolor\eplaindefinecolor

% protect and restore original repeat
\let\knuthrepeat=\repeat
\input repeat
\let\Repeat=\repeat
\let\repeat=\knuthrepeat

% not currently used
%\input insbox

%%}}}

%%{{{ ThaTeX hyperlinks 
% Hyperlinks woohoo!
\enablehyperlinks [dvipdfm]
%\definecolor{urlcolor}{rgb}{.7,.2,.2}
\hlopts{bwidth=0}
\hlopts{colormodel=cmyk,color={.4,1,.6,.1}}
\hlopts[url]{colormodel=cmyk,color={1,.4,.6,.1}}
\hlopts[hrefext]{colormodel=cmyk,color={1,.4,.6,.1}}
\hlopts[eq]{colormodel=cmyk,color={1,1,0,.1}}
\def\UrlFont{\twelvett}
%\hlopts[page]{colormodel=cmyk,color={1,.2,.1,.5}}
\def\hlprintpage#1{\hlstart{name}{}{TOCPG#1}#1\hlend}
\def\hldestizepage{\hldest{fit}{}{TOCPG\the\pageno}}
%%}}}

%%{{{ ThaTeX sidekick 
\def\ThaTeX{\hbox{$\Theta$\kern-.1333em\lower.5ex\hbox{${\acute\alpha}$}\kern-.21em\TeX}}
\def\ifEqStr#1#2{\def\stra{#1}\def\strb{#2}\ifx\stra\strb}% XXX: this pollutes the namespace
\def\ifEmpty#1{\ifx\empty#1}
\def\ifnull#1\\{\expandafter\ifx\csname empty#1\endcsname\empty}
\def\blank{\hbox{}}
\def\toupper#1{\uppercase\expandafter{#1}}
\def\tolower#1{\lowercase\expandafter{#1}}
\def\twodigitfmt#1{\ifnum #1<10 0\fi#1}
\long\def\ignore#1{}
\def\boxit#1#2{\hbox{\vrule\vtop{\vbox{\hrule\kern#1\hbox{\kern#1#2\kern#1}}\kern#1\hrule}\vrule\relax}}
\def\frameit#1#2#3{\hbox{\vrule width #1\vtop{\vbox{\hrule height #1\kern#2\hbox{\kern#2#3\kern#2}}\kern#2\hrule height #1}\vrule width #2\relax}}
\def\frameit#1#2#3{\hbox{\vrule width #1\vtop{\vbox{\hrule height #1\kern#2\hbox{\kern#2#3\kern#2}}\kern#2\hrule height #1}\vrule width #2\relax}}
\let\footnote=\numberedfootnote
\def\qqquad{\hskip 3em\relax}
\def\qqqquad{\hskip 4em\relax}
% \eolfill ensures the next thing is placed at the end of the same or the next line
\def\eolfill{\ifhmode\unskip\nobreak\fi\hbox{}\hfill\hbox{}\nobreak}% XXX 
\def\XXXeolfill{\ifhmode\phantom.\fi\ifhmode\unskip\nobreak\fi\hbox{}\hfill\hbox{}\nobreak}% XXX 
\def\CR{\newline}
\def\nrepeat#1#2{\Repeat \for{i} \from{1} \to{#1} \do{#2}}
\def\colorboxfb#1#2#3{\colorbox{#2}{\color{#1}#3}}% colorbox fg in bg
\def\procrustes{{\vphantom{Tj}}}
\def\procrustext#1{\text{\procrustes#1}}
\def\procruster{{\vphantom{{}^T_j}}}% even more extreme for math
\def\procrustest{{\vphantom{{}^{T^T}_{j_j}}}}% even more!
%%}}}

%%{{{ ThaTeX numerals 
%\def\asciinumeral#1 offset #2{\advance#1 by #2\relax\char#1\advance#1 by -#2}
\def\asciinumeral#1 offset #2{{\innernewcount\tmp\tmp=#1\relax\advance\tmp by #2\relax\char\tmp}}
\def\Alphabetnumeral#1{\asciinumeral#1 offset {64}}
\def\alphabetnumeral#1{\asciinumeral#1 offset {96}}
%\def\Romannumeral#1{\toupper{\romannumeral#1}}
\def\Romannumeralof#1{\uppercase\expandafter{\romannumeral#1\relax}}
%%}}}

%%{{{ ThaTeX abbrev macros 
\def\today#1{\the\year#1\relax\ifnum\month<10 0\fi\the\month\relax#1\ifnum\day<10 0\fi\the\day\relax}
\def\humantime{
\innernewcount\hours
\innernewcount\minutes
\hours=\time
\divide\hours by 60
\minutes=\hours
\multiply\minutes by 60
\advance\minutes by -\time
\multiply\minutes by -1
\twodigitfmt{\the\hours}:\twodigitfmt{\the\minutes}
}
\let\numfootnote=\numberedfootnote\relax
%%}}}

%%{{{ ThaTeX lists 
\def\beginol{\orderedlist}
\def\endol{\endorderedlist\noindent}
\def\endolp{\endorderedlist\endgraf}
\def\beginul{\unorderedlist}
\def\endul{\endunorderedlist\noindent}
\def\endulp{\endunorderedlist\endgraf}
\def\beginil{\begingroup\abovelistskip} % begin plain \item-list
\def\endil{\endgroup\belowlistskip\noindent}
\def\endilp{\endgroup\belowlistskip\endgraf}
\def\endilnoskip{\endgroup}
%%}}}

%%{{{ ThaTeX draft 
\definecolor{todocolor}{rgb}{.0,.5,.75}
\definecolor{todocolorinv}{rgb}{1,1,1}
\def\TODO#1\par{{}\endgraf\noindent {\llap{\colorboxfb{todocolorinv}{todocolor}{\sfmbf~~TODO~~}\enspace}{\color{todocolor}\sf #1}}\par}
%%}}}

%%{{{ ThaTeX text 
\def\emph#1{{\it #1}}
\def\strikeout#1{$\tikz[baseline] \node [strike out,draw,anchor=text,inner sep=0pt,text=black]{$\text{#1}$};$}
\def\yearof#1{\oldstyle{#1}}
\definecolor{alertR}{rgb}{.9,.0,.0}
\definecolor{alertG}{rgb}{.0,.7,.0}
\definecolor{alertB}{rgb}{.0,.0,.999}
\definecolor{normal}{rgb}{.0,.0,.0}
\definecolor{spoiler}{rgb}{.666,.666,.666}
\definecolor{faded}{rgb}{.666,.666,.666}
\definecolor{trueR}{rgb}{1,0,0}
\definecolor{trueG}{rgb}{0,1,0}
\definecolor{trueB}{rgb}{0,0,1}
\def\alertR#1{{\color{alertR}#1}}
\def\alertG#1{{\color{alertG}#1}}
\def\alertB#1{{\color{alertB}#1}}
\def\trueR#1{{\color{trueR}#1}}
\def\trueG#1{{\color{trueG}#1}}
\def\trueB#1{{\color{trueB}#1}}
\let\alert=\alertR
\let\alerta=\alert
\let\alertb=\alertB
\let\alertc=\alertG
\def\faded#1{{\color{faded}#1}}
\def\standout#1\endstandout{%
\endgraf
\bigskip
\centerline{#1}
\bigskip
\endgraf
\noindent
}
\def\quote{%
\endgraf
\medskip
\advance \leftskip 2\parindent \advance \rightskip 2\parindent%
\begingroup
\noindent
}
\def\quotepar{\quote\indent}
\def\endquote{%
\endgraf
\endgroup
\medskip
\advance \leftskip -2\parindent \advance \rightskip -2\parindent%
\noindent
}
\def\leftindent{%
\endgraf
\smallskip
\advance \leftskip 2\parindent%
\begingroup
\noindent
}
\def\endleftindent{%
\endgraf
\endgroup
\smallskip
\advance \leftskip -2\parindent%
\noindent
}
\def\spoken#1\endspoken{\quote\emph{#1}\endquote}
\def\dialogue#1\enddialogue{{\beginil\def\say{\item{--}}\def\who##1{\item{##1:}}#1\endil}}
\def\tablerule{\noalign{\smallskip\hrule\smallskip}}
\def\tablethickrule{\noalign{\smallskip\hrule\hrule\hrule\smallskip}}
\def\tabletoprule{\noalign{\hrule\smallskip}}
\def\tablebottomrule{\noalign{\smallskip\hrule}}
\def\tool#1{{\sf #1}}
\def\symquote#1{`\,#1\,'}
\def\symqquote#1{``\,#1\,''}
\def\wordquote#1{<<#1>>}
\def\singlequote#1{`#1'}
\def\doublequote#1{``#1''}
\def\mathsymquote#1{\text{\symquote{$#1$}}}
\def\mathsymqquote#1{\text{\symqquote{$#1$}}}
\def\textwq#1{\text{\wq{#1}}}
\let\symq=\symquote
\let\symqq=\symqquote
\let\wq=\wordquote
\let\sq=\singlequote
\let\dq=\doublequote
\let\msymq=\mathsymquote
\let\msymqq=\mathsymqquote
\def\flwq#1{\kern-1.333ex\wq{#1}}% floating left wq, for use in \quote's etc.
\def\dotspc{{.} }% XXX: to work with \remark, etc.
\def\versus{vs\dotspc}% XXX: to work with \remark, etc.
\let\vs=\versus
\def\paracrase{% TODO: maybe abstract accent and letter away? 
$
\mathord{%
{}\kern-.3ex%
{{}^{{}^{{}_(}}}%
\kern-.6ex%
\text{à}%
\kern-.4ex%
{{}^{{}^{{}_)}}}%
\kern-.48ex{}%
}
$%
}
%%}}}

%%{{{ ThaTeX aux files
\def\safereadfile#1{
\testfileexistence{#1}%
\iffileexists%
\input \jobname.#1%
\fi%
}
%%}}}

%%{{{ ThaTeX ifs 

% versions of book:
\newif\ifprint\printfalse  % printed
\newif\ifdraft\drafttrue

%%}}}

%%{{{ ThaTeX titles and page decorations 

\newif\iftitlepage          \titlepagefalse
\newtoks\titlepagehead      \titlepagehead={\hfil}
\newtoks\titlepagefoot      \titlepagefoot={\hfil\twelverm---~{\oldstyle{\number\pageno}}~---\hfil}
\newtoks\toptitle           \toptitle={\hfil}
\newtoks\topmarker          \topmarker={\hfil}
\newtoks\oddpagehead        \oddpagehead={\hfil}
\newtoks\evenpagehead       \evenpagehead={\hfil}
\newtoks\evenpagefoot       \evenpagefoot={\hfil}
\newtoks\oddpagefoot        \oddpagefoot={\hfil}

% defaults
\oddpagehead={\nineit\the\toptitle\hfil\llap{\enspace\ninebf\number\pageno}}
\evenpagehead={\rlap{\ninebf\number\pageno\enspace}\hfil\nineit\the\topmarker}
\evenpagefoot={\hfil}
\oddpagefoot={\hfil}

\headline={%
\iftitlepage\the\titlepagehead
\else\ifodd\pageno\the\oddpagehead
\else\the\evenpagehead\fi\fi
}

\footline={%
\iftitlepage\the\titlepagefoot
\global\titlepagefalse
\else\ifodd\pageno\the\oddpagefoot
\else\the\evenpagefoot\fi\fi
}

\def\nohead{\headline={}}
\def\nofoot{\footline={}}

\def\nodecorspage{\nohead\nofoot}
\def\blankpage{{\nodecorspage\null\eject}}
\def\oddpage{\ifodd\pageno\else\blankpage\fi}
\def\makenextpageodd{\ifodd\pageno\eject\null\blankpage\fi}
\def\partpage{\oddpage\nodecorspage}
\def\titlepage{\titlepagetrue}

%%}}}

%%{{{ ThaTeX inserts 

%%{{{ amscaptions: code taken form amsppt.sty
\makeatletter
\def\first@#1#2\end{#1}
\def\true@{TT}
\def\false@{TF}
\def\empty@{}
\begingroup  \catcode`\-=3
\long\gdef\notempty#1{%
  \expandafter\ifx\first@#1-\end-\empty@ \false@\else \true@\fi}
\endgroup
\def\captionfont{}
\def\topcaption#1#2\endcaption{%
  {\dimen@\hsize \advance\dimen@-\captionwidth@
   \rm\raggedcenter@ \advance\leftskip.5\dimen@ \rightskip\leftskip
  {\captionfont#1}%
  \if\notempty{#2}\if\notempty{#1}.\enspace\fi\ignorespaces#2\fi
  \endgraf}\nobreak\bigskip}
\def\botcaption#1#2\endcaption{%
  \nobreak\bigskip
  \setboxz@h{\captionfont#1\if\notempty{#2}\if\notempty{#1}.\enspace\fi
    \rm\ignorespaces#2\fi}%
  {\dimen@\hsize \advance\dimen@-\captionwidth@
   \leftskip.5\dimen@ \rightskip\leftskip
   \noindent \ifdim\wdz@>\captionwidth@
   \else\hfil\fi
  {\captionfont#1}%
  \if\notempty{#2}\if\notempty{#1}.\enspace\fi\rm\ignorespaces#2\fi\endgraf}}
\makeatother
%%}}}

\let\amstopinsert=\topinsert
\let\amsmidinsert=\midinsert
\let\amsendinsert=\endinsert
\def\topinsert{\amstopinsert\noindent}
\def\midinsert{\goodbreak\amsmidinsert\noindent}

%%}}}

